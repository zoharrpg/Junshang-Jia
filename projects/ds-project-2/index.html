<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  <link href='&#x2F;icons&#x2F;site.webmanifest' rel="manifest" />
  
  
  <link color="#5bbad5" href='&#x2F;icons&#x2F;safari-pinned-tab.svg' rel="mask-icon" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-16x16.png' rel="icon" sizes="16x16" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-32x32.png' rel="icon" sizes="32x32" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;apple-touch-icon.png' rel="apple-touch-icon" sizes="180x180" />
  

  

  

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css" integrity="sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link href="https://zoharrpg.github.io/Junshang-Jia/deep-thought.css" rel="stylesheet" />
  
  

  <title>
    
Junshang Jia | The Raft Consensus Algorithm

  </title>

  
  
  

  
</head>

<body class="has-background-white">
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item is-size-5 has-text-weight-bold" href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia">Junshang Jia</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;projects">
            Projects
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;categories">
            Categories
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;document&#x2F;current-resume&#x2F;Junshang_Jia_resume.pdf">
            Resume
          </a>
          
          
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  
  

  
<section class="section">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article class="box">
          <h1 class="title">
            The Raft Consensus Algorithm
          </h1>
          <p class="subtitle"></p>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="fas fa-user"></i>
  </span>
  <span>Junshang Jia published on</span>
  <span class="icon">
    <i class="far fa-calendar-alt"></i>
  </span>
  <span><time datetime="2023-12-18">December 18, 2023</time></span>
</span>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="far fa-clock"></i>
  </span>
  <span>7 min,</span>
  <span class="icon">
    <i class="fas fa-pencil-alt"></i>
  </span>
  <span>1249 words</span>
</span>

            </div>
            <div class="column">
              
              
<p>
  Categories:
  
  <a class="has-text-info-dark has-text-weight-semibold" href="https://zoharrpg.github.io/Junshang-Jia/categories/cmu-15640/">
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-cube"></i>
      </span>
      <span>CMU-15640</span>
    </span>
  </a>
  
  <a class="has-text-info-dark has-text-weight-semibold" href="https://zoharrpg.github.io/Junshang-Jia/categories/distributed-system/">
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-cube"></i>
      </span>
      <span>Distributed System</span>
    </span>
  </a>
  
</p>

              
            </div>
            <div class="column has-text-right-desktop">
              
            </div>
          </div>
          <div class="content mt-2">
            <h1 id="overview">Overview</h1>
<p>CMU-15640 Distributed Systems Project 2<br>
A replicated service (e.g., key/value database) achieves fault tolerance by storing copies of its data on multiple replicas. Replication allows the service to continue operating even if some of its replicas experience failures (crashes or a broken/flaky network). The challenge is that failures may cause the replicas to hold differing copies of the data.</p>
<p>One protocol to ensure all of these copies of the data are consistent across all non-faulty replicas is Raft. Raft implements a replicated state machine by sequencing client requests into a log, and ensuring that the replicas agree on the contents and ordering of the log entries. Each replica asynchronously applies the client requests in the order they appear in the replica’s log of the service’s state. If a replica fails and later recovers, Raft takes care of bringing the log of the recovered replica up to date. Raft will continue to operate as long as at least a quorum of replicas is alive and able to communicate. If a quorum is not available, Raft will stop making progress but will resume as soon as a quorum becomes available.</p>
<p><a href="https://github.com/zoharrpg/Raft">Source Code Link</a><br>

<a href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;15640-doc&#x2F;p2_23.pdf">Write-Up</a></p>
<h1 id="raft-implementation">Raft Implementation</h1>
<h2 id="introduction">Introduction</h2>
<p>In this project, the Raft algorithm uses Remote Procedure Call(RPC) to send and receive requests from other servers. This algorithm does involve a lot code, but it is really hard to debug and has a many deadlocks and performance issue when I implemented. State transitation and vote process are the headest parts in this project.

<img src="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;processed_images&#x2F;p2-pic1.4f554ba1b8883259.png" /></p>
<h2 id="main-data-structs">Main Data Structs</h2>
<p>Each server needs to send heartbeats to the leader and send appendEntries message to append logs. Also, there is a term concept to avoid duplicate Leader in the distributed systems</p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#b48ead;">type </span><span>Raft </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">mux   sync</span><span>.</span><span style="color:#b48ead;">Mutex       </span><span style="color:#65737e;">// Lock to protect shared access to this peer&#39;s state
</span><span>	</span><span style="color:#bf616a;">peers </span><span>[]*</span><span style="color:#bf616a;">rpc</span><span>.</span><span style="color:#b48ead;">ClientEnd </span><span style="color:#65737e;">// RPC end points of all peers
</span><span>	</span><span style="color:#bf616a;">me    </span><span style="color:#b48ead;">int              </span><span style="color:#65737e;">// this peer&#39;s index into peers[]
</span><span>	</span><span style="color:#65737e;">// You are expected to create reasonably clear log files before asking a
</span><span>	</span><span style="color:#65737e;">// debugging question on Edstem or OH. Use of this logger is optional, and
</span><span>	</span><span style="color:#65737e;">// you are free to remove it completely.
</span><span>	</span><span style="color:#bf616a;">logger </span><span>*</span><span style="color:#bf616a;">log</span><span>.</span><span style="color:#b48ead;">Logger </span><span style="color:#65737e;">// We provide you with a separate logger per peer.
</span><span>
</span><span>	</span><span style="color:#bf616a;">ElectionTimeout </span><span style="color:#b48ead;">int </span><span style="color:#65737e;">// heartbeat timeout
</span><span>
</span><span>	</span><span style="color:#bf616a;">Interval </span><span style="color:#b48ead;">int
</span><span>
</span><span>	</span><span style="color:#bf616a;">currentTerm </span><span style="color:#b48ead;">int </span><span style="color:#65737e;">// Term for each serve
</span><span>
</span><span>	</span><span style="color:#bf616a;">state </span><span style="color:#b48ead;">State </span><span style="color:#65737e;">// State of the server
</span><span>
</span><span>	</span><span style="color:#bf616a;">votedFor </span><span style="color:#b48ead;">int </span><span style="color:#65737e;">// vote information
</span><span>
</span><span>	</span><span style="color:#bf616a;">applyCh </span><span style="color:#b48ead;">chan ApplyCommand
</span><span>
</span><span>	</span><span style="color:#bf616a;">hearthbeat_signal </span><span style="color:#b48ead;">chan int
</span><span>
</span><span>	</span><span style="color:#bf616a;">step_down_signal </span><span style="color:#b48ead;">chan int </span><span style="color:#65737e;">// down level the state of the server
</span><span>
</span><span>	</span><span style="color:#bf616a;">logs </span><span>[]</span><span style="color:#b48ead;">LogStruct
</span><span>
</span><span>	</span><span style="color:#bf616a;">commitIndex </span><span style="color:#b48ead;">int
</span><span>
</span><span>	</span><span style="color:#bf616a;">lastApplied </span><span style="color:#b48ead;">int
</span><span>
</span><span>	</span><span style="color:#65737e;">// leader part
</span><span>	</span><span style="color:#bf616a;">nextIndex </span><span>[]</span><span style="color:#b48ead;">int
</span><span>
</span><span>	</span><span style="color:#bf616a;">matchIndex </span><span>[]</span><span style="color:#b48ead;">int
</span><span>}
</span></code></pre>
<p>Message structs are used for RPC</p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#65737e;">// RequestVoteArgs
</span><span style="color:#65737e;">// ===============
</span><span style="color:#65737e;">//
</span><span style="color:#65737e;">// Example RequestVote RPC arguments structure.
</span><span style="color:#65737e;">//
</span><span style="color:#65737e;">// # Please note: Field names must start with capital letters!
</span><span style="color:#b48ead;">type </span><span>RequestVoteArgs </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">Term         </span><span style="color:#b48ead;">int
</span><span>	</span><span style="color:#bf616a;">CandidateId  </span><span style="color:#b48ead;">int
</span><span>	</span><span style="color:#bf616a;">LastLogIndex </span><span style="color:#b48ead;">int
</span><span>	</span><span style="color:#bf616a;">LastLogTerm  </span><span style="color:#b48ead;">int
</span><span>	</span><span style="color:#65737e;">// TODO - Your data here (2A, 2B)
</span><span>}
</span><span>
</span><span style="color:#65737e;">// RequestVoteReply
</span><span style="color:#65737e;">// ================
</span><span style="color:#65737e;">//
</span><span style="color:#65737e;">// Example RequestVote RPC reply structure.
</span><span style="color:#65737e;">//
</span><span style="color:#65737e;">// # Please note: Field names must start with capital letters!
</span><span style="color:#65737e;">// The RequestVoteReply type is used to store the response to a request for vote in a distributed
</span><span style="color:#65737e;">// consensus algorithm.
</span><span style="color:#65737e;">// @property {int} Term - The Term property represents the current term of the candidate requesting the
</span><span style="color:#65737e;">// vote. It is an integer value that is used to keep track of the current election term.
</span><span style="color:#65737e;">// @property {bool} VoteGranted - A boolean value indicating whether the vote has been granted or not.
</span><span style="color:#b48ead;">type </span><span>RequestVoteReply </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">Term        </span><span style="color:#b48ead;">int
</span><span>	</span><span style="color:#bf616a;">VoteGranted </span><span style="color:#b48ead;">bool
</span><span>
</span><span>	</span><span style="color:#65737e;">// TODO - Your data here (2A)
</span><span>}
</span><span>
</span><span style="color:#65737e;">// The `AppendEntriesArgs` type represents the arguments for an append entries RPC call in a
</span><span style="color:#65737e;">// distributed system.
</span><span style="color:#65737e;">// @property {int} Term - The current term of the leader sending the AppendEntries RPC.
</span><span style="color:#65737e;">// @property {int} LeaderId - The LeaderId property represents the unique identifier of the leader in a
</span><span style="color:#65737e;">// distributed system.
</span><span style="color:#65737e;">// @property {int} PrevLogIndex - PrevLogIndex is the index of the log entry immediately preceding the
</span><span style="color:#65737e;">// new entries being sent in the AppendEntries RPC.
</span><span style="color:#65737e;">// @property {int} PrevLogTerm - PrevLogTerm is the term of the log entry immediately preceding the new
</span><span style="color:#65737e;">// log entries being sent in the AppendEntries RPC.
</span><span style="color:#65737e;">// @property {[]LogStruct} Entries - The `Entries` property is a slice of `LogStruct` objects. It
</span><span style="color:#65737e;">// represents the log entries that the leader wants to append to the follower&#39;s log.
</span><span style="color:#65737e;">// @property {int} LeaderCommit - LeaderCommit is the index of the highest log entry known to be
</span><span style="color:#65737e;">// committed by the leader.
</span><span style="color:#b48ead;">type </span><span>AppendEntriesArgs </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">Term         </span><span style="color:#b48ead;">int
</span><span>	</span><span style="color:#bf616a;">LeaderId     </span><span style="color:#b48ead;">int
</span><span>	</span><span style="color:#bf616a;">PrevLogIndex </span><span style="color:#b48ead;">int
</span><span>	</span><span style="color:#bf616a;">PrevLogTerm  </span><span style="color:#b48ead;">int
</span><span>	</span><span style="color:#bf616a;">Entries      </span><span>[]</span><span style="color:#b48ead;">LogStruct
</span><span>	</span><span style="color:#bf616a;">LeaderCommit </span><span style="color:#b48ead;">int
</span><span>}
</span><span>
</span><span style="color:#65737e;">// The AppendEntriesReply type represents a response to an append entries request in the Go programming
</span><span style="color:#65737e;">// language.
</span><span style="color:#65737e;">// @property {int} Term - The &quot;Term&quot; property represents the term of the leader that sent the
</span><span style="color:#65737e;">// AppendEntries RPC (Remote Procedure Call). It is an integer value that is used to ensure that
</span><span style="color:#65737e;">// followers are up to date and do not fall behind in terms of the leader&#39;s log.
</span><span style="color:#65737e;">// @property {bool} Success - A boolean value indicating whether the AppendEntries RPC request was
</span><span style="color:#65737e;">// successful or not. If Success is true, it means that the log entries were successfully appended to
</span><span style="color:#65737e;">// the receiver&#39;s log. If Success is false, it means that the receiver rejected the log entries due to
</span><span style="color:#65737e;">// inconsistencies or other reasons.
</span><span style="color:#b48ead;">type </span><span>AppendEntriesReply </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">Term    </span><span style="color:#b48ead;">int
</span><span>	</span><span style="color:#bf616a;">Success </span><span style="color:#b48ead;">bool
</span><span>}
</span></code></pre>
<h2 id="vote-process">Vote Process</h2>
<p>Candidates can request votes from other followers. The hardest part is handling the signals from other followers. My approach is using the RPC to get the vote information. If the votes is greater than half of number of the servers, the candidate become the leader. Handling signals is very difficule here, because it is hard to know whether the follower server vote for the candidate. The channel may wait for a very long time for the vote process. Another problem is that there is only channel, and there are multiple senders with one receiver. Due to the multiple senders, it is hard to manage and close channel. My approach is create a new channel for each vote process and make it manage by go runtime, which is not a good way. </p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#b48ead;">func </span><span>(</span><span style="color:#bf616a;">rf </span><span>*</span><span style="color:#b48ead;">Raft</span><span>) </span><span style="color:#8fa1b3;">ProcessCandidateState</span><span>() {
</span><span>	</span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">initState</span><span>(</span><span style="color:#bf616a;">CANDIDATE</span><span>)
</span><span>	</span><span style="color:#65737e;">//rf.Clear()
</span><span>
</span><span>	</span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">setVotedFor</span><span>(</span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">me</span><span>)
</span><span>	</span><span style="color:#bf616a;">t </span><span>:= </span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">getTerm</span><span>() + </span><span style="color:#d08770;">1
</span><span>	</span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">setTerm</span><span>(</span><span style="color:#bf616a;">t</span><span>)
</span><span>	</span><span style="color:#bf616a;">lastIndex</span><span>, </span><span style="color:#bf616a;">lastTerm </span><span>:= </span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">getLastLogInfo</span><span>()
</span><span>	</span><span style="color:#bf616a;">vote_count </span><span>:= </span><span style="color:#d08770;">1
</span><span>	</span><span style="color:#bf616a;">vote_signal </span><span>:= </span><span style="color:#96b5b4;">make</span><span>(</span><span style="color:#b48ead;">chan bool</span><span>)
</span><span>	</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">peer </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">peers </span><span>{
</span><span>		</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">peer </span><span>!= </span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">me </span><span>{
</span><span>			</span><span style="color:#bf616a;">reply </span><span>:= </span><span style="color:#bf616a;">RequestVoteReply</span><span>{}
</span><span>			</span><span style="color:#bf616a;">args </span><span>:= </span><span style="color:#bf616a;">RequestVoteArgs</span><span>{</span><span style="color:#bf616a;">CandidateId</span><span>: </span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">me</span><span>, </span><span style="color:#bf616a;">Term</span><span>: </span><span style="color:#bf616a;">t</span><span>, </span><span style="color:#bf616a;">LastLogIndex</span><span>: </span><span style="color:#bf616a;">lastIndex</span><span>, </span><span style="color:#bf616a;">LastLogTerm</span><span>: </span><span style="color:#bf616a;">lastTerm</span><span>}
</span><span>
</span><span>			</span><span style="color:#b48ead;">go </span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">sendRequestVote</span><span>(</span><span style="color:#bf616a;">peer</span><span>, &amp;</span><span style="color:#bf616a;">args</span><span>, &amp;</span><span style="color:#bf616a;">reply</span><span>, </span><span style="color:#bf616a;">vote_signal</span><span>)
</span><span>
</span><span>		}
</span><span>	}
</span><span>
</span><span>	</span><span style="color:#b48ead;">for </span><span>{
</span><span>		</span><span style="color:#65737e;">//rf.logger.Printf(&quot;Election pid is %d Vote Pending\n&quot;, pid)
</span><span>		</span><span style="color:#b48ead;">select </span><span>{
</span><span>		</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">term </span><span>:= &lt;-</span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">step_down_signal</span><span>:
</span><span>			</span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">setTerm</span><span>(</span><span style="color:#bf616a;">term</span><span>)
</span><span>			</span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">setVotedFor</span><span>(-</span><span style="color:#d08770;">1</span><span>)
</span><span>
</span><span>			</span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">logger</span><span>.</span><span style="color:#bf616a;">Printf</span><span>(&quot;</span><span style="color:#a3be8c;">Candidate </span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;"> to follower</span><span>&quot;, </span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">me</span><span>)
</span><span>			</span><span style="color:#b48ead;">go </span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">ProcessFollowerState</span><span>()
</span><span>			</span><span style="color:#b48ead;">return
</span><span>
</span><span>		</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">isVoted </span><span>:= &lt;-</span><span style="color:#bf616a;">vote_signal</span><span>:
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">isVoted </span><span>{
</span><span>
</span><span>				</span><span style="color:#bf616a;">vote_count</span><span>++
</span><span>
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">vote_count </span><span>&gt; </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">peers</span><span>)/</span><span style="color:#d08770;">2 </span><span>{
</span><span>					</span><span style="color:#b48ead;">go </span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">ProcessLeader</span><span>()
</span><span>					</span><span style="color:#b48ead;">return
</span><span>
</span><span>					</span><span style="color:#65737e;">//rf.logger.Println(&quot;Leader selected&quot;)
</span><span>
</span><span>				}
</span><span>
</span><span>			}
</span><span>		</span><span style="color:#b48ead;">case </span><span>&lt;-</span><span style="color:#bf616a;">time</span><span>.</span><span style="color:#bf616a;">After</span><span>(</span><span style="color:#bf616a;">time</span><span>.</span><span style="color:#bf616a;">Duration</span><span>(</span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">ElectionTimeout</span><span>) * </span><span style="color:#bf616a;">time</span><span>.</span><span style="color:#bf616a;">Millisecond</span><span>):
</span><span>			</span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">logger</span><span>.</span><span style="color:#bf616a;">Printf</span><span>(&quot;</span><span style="color:#a3be8c;">Candidate </span><span style="color:#d08770;">%d</span><span style="color:#a3be8c;"> reelection</span><span>&quot;, </span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">me</span><span>)
</span><span>
</span><span>			</span><span style="color:#b48ead;">go </span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">ProcessCandidateState</span><span>()
</span><span>
</span><span>			</span><span style="color:#b48ead;">return
</span><span>
</span><span>		}
</span><span>
</span><span>	}
</span><span>
</span><span>}
</span><span>
</span><span style="color:#65737e;">// The above code is a method in the Raft struct that is used to send a RequestVote RPC to a specific
</span><span style="color:#65737e;">// server. It takes in the server index, the arguments for the RequestVote RPC, a reply struct to store
</span><span style="color:#65737e;">// the response, and a vote_signal channel to signal whether the vote was granted or not.
</span><span>
</span><span style="color:#b48ead;">func </span><span>(</span><span style="color:#bf616a;">rf </span><span>*</span><span style="color:#b48ead;">Raft</span><span>) </span><span style="color:#8fa1b3;">sendRequestVote</span><span>(</span><span style="color:#bf616a;">server </span><span style="color:#b48ead;">int</span><span>, </span><span style="color:#bf616a;">args </span><span>*</span><span style="color:#b48ead;">RequestVoteArgs</span><span>, </span><span style="color:#bf616a;">reply </span><span>*</span><span style="color:#b48ead;">RequestVoteReply</span><span>, </span><span style="color:#bf616a;">vote_signal </span><span style="color:#b48ead;">chan bool</span><span>) {
</span><span>	</span><span style="color:#bf616a;">ok </span><span>:= </span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">peers</span><span>[</span><span style="color:#bf616a;">server</span><span>].</span><span style="color:#bf616a;">Call</span><span>(&quot;</span><span style="color:#a3be8c;">Raft.RequestVote</span><span>&quot;, </span><span style="color:#bf616a;">args</span><span>, </span><span style="color:#bf616a;">reply</span><span>)
</span><span>	</span><span style="color:#65737e;">//rf.logger.Println(*reply == RequestVoteReply{})
</span><span>	</span><span style="color:#65737e;">//rf.logger.Println(&quot;ok state is &quot;, ok)
</span><span>
</span><span>	</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">ok </span><span>{
</span><span>		</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">reply</span><span>.</span><span style="color:#bf616a;">Term </span><span>&gt; </span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">getTerm</span><span>() {
</span><span>			</span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">setVotedFor</span><span>(-</span><span style="color:#d08770;">1</span><span>)
</span><span>			</span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">setState</span><span>(</span><span style="color:#bf616a;">FOLLOWER</span><span>)
</span><span>			</span><span style="color:#bf616a;">rf</span><span>.</span><span style="color:#bf616a;">step_down_signal </span><span>&lt;- </span><span style="color:#bf616a;">reply</span><span>.</span><span style="color:#bf616a;">Term
</span><span>			</span><span style="color:#b48ead;">return
</span><span>		}
</span><span>
</span><span>		</span><span style="color:#bf616a;">vote_signal </span><span>&lt;- </span><span style="color:#bf616a;">reply</span><span>.</span><span style="color:#bf616a;">VoteGranted
</span><span>	}
</span><span>
</span><span>}
</span></code></pre>
<h2 id="potential-improvement">Potential Improvement</h2>
<p>My design for vote process is not a good design, and the problem is huge. A better practice for handling signal is <strong>Close the Channel from Sender side</strong>. Multiple senders and on receiver is not a good design. A better way is to use dynamic Select handle signal from each follower.</p>
<p>Another approach is waiting for the all the vote result from all other servers.</p>
<h1 id="detial-raft-explanation-video">Detial Raft Explanation Video</h1>
<div class="youtube is-flex is-justify-content-center is-align-items-center">
    <iframe
        width="848" height="510"
        src="https://www.youtube.com/embed/IujMVjKvWP4"
        frameborder="0" 
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
        allowfullscreen>
    </iframe>
</div>
          </div>
        </article>
      </div>
      
      <div class="column is-2 is-hidden-mobile">
        <aside class="menu" style="position: sticky; top: 48px">
          <p class="heading has-text-weight-bold">Contents</p>
          <ul class="menu-list">
            
            <li>
              <a id="link-overview" class="toc is-size-7 is-active"
                href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-2/#overview">
                Overview
              </a>
              
            </li>
            
            <li>
              <a id="link-raft-implementation" class="toc is-size-7 "
                href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-2/#raft-implementation">
                Raft Implementation
              </a>
              
              <ul>
                
                <li>
                  <a id="link-introduction" class="toc is-size-7" href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-2/#introduction">
                    Introduction
                  </a>
                </li>
                
                <li>
                  <a id="link-main-data-structs" class="toc is-size-7" href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-2/#main-data-structs">
                    Main Data Structs
                  </a>
                </li>
                
                <li>
                  <a id="link-vote-process" class="toc is-size-7" href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-2/#vote-process">
                    Vote Process
                  </a>
                </li>
                
                <li>
                  <a id="link-potential-improvement" class="toc is-size-7" href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-2/#potential-improvement">
                    Potential Improvement
                  </a>
                </li>
                
              </ul>
              
            </li>
            
            <li>
              <a id="link-detial-raft-explanation-video" class="toc is-size-7 "
                href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-2/#detial-raft-explanation-video">
                Detial Raft Explanation Video
              </a>
              
            </li>
            
          </ul>
        </aside>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Search</p>
      </header>
      <section class="modal-card-body">
        <div class="field mb-2">
          <div class="control">
            <input class="input" id="search" placeholder="Search this website." type="search" />
          </div>
        </div>
        <div class="search-results">
          <div class="search-results__items"></div>
        </div>
      </section>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


  

<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <nav class="level">
              
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;projects&#x2F;ds-project-1&#x2F;">
              <span class="icon mr-2">
                <i class="fas fa-arrow-circle-left"></i>
              </span>
              Live Sequence Protocol and Distributed Bitcoin Miner
            </a>
          </div>
           
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;projects&#x2F;ds-project-3&#x2F;">
              Multi-User Dungeon-CMUD<span class="icon ml-2">
                <i class="fas fa-arrow-circle-right"></i>
              </span>
            </a>
          </div>
          
        </nav>
      </div>
    </div>
  </div>
</section>



  



  
  <footer class="footer py-4">
    <div class="content has-text-centered">
      <p>
        Built with
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-code"></i>
          </span>
          <span>code</span>
        </span>
        and
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-heart"></i>
          </span>
          <span>love</span>
        </span>
      </p>
      <p>
        Powered by
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-power-off"></i>
          </span>
          <span>zola</span>
        </span>
      </p>
    </div>
  </footer>
  

  
  
  
  
  <script src="https://zoharrpg.github.io/Junshang-Jia/elasticlunr.min.js"></script>
  <script src="https://zoharrpg.github.io/Junshang-Jia/search_index.en.js"></script><script src="https://zoharrpg.github.io/Junshang-Jia/js/site.js"></script>

  

<script type="text/javascript">
  const menuBarHeight = document.querySelector("nav.navbar").clientHeight;
  const tocItems = document.querySelectorAll(".toc");
  const navSections = new Array(tocItems.length);

  tocItems.forEach((el, i) => {
    let id = el.getAttribute("id").substring(5);
    navSections[i] = document.getElementById(id);
  })

  function isVisible(tocIndex) {
    const current = navSections[tocIndex];
    const next = tocIndex < tocItems.length - 1 ? navSections[tocIndex + 1]
      : document.querySelectorAll("section.section").item(1);

    const c = current.getBoundingClientRect();
    const n = next.getBoundingClientRect();
    const h = (window.innerHeight || document.documentElement.clientHeight);

    return (c.top <= h) && (n.top - menuBarHeight >= 0);
  }

  function activateIfVisible() {
    for (b = true, i = 0; i < tocItems.length; i++) {
      if (b && isVisible(i)) {
        tocItems[i].classList.add('is-active');
        b = false;
      } else
        tocItems[i].classList.remove('is-active');
    }
  }

  var isTicking = null;
  window.addEventListener('scroll', () => {
    if (!isTicking) {
      window.requestAnimationFrame(() => {
        activateIfVisible();
        isTicking = false;
      });
      isTicking = true;
    }
  }, false);
</script>





  
  
</body>

</html>
