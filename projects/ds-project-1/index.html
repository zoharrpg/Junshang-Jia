<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  <link href='&#x2F;icons&#x2F;site.webmanifest' rel="manifest" />
  
  
  <link color="#5bbad5" href='&#x2F;icons&#x2F;safari-pinned-tab.svg' rel="mask-icon" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-16x16.png' rel="icon" sizes="16x16" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-32x32.png' rel="icon" sizes="32x32" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;apple-touch-icon.png' rel="apple-touch-icon" sizes="180x180" />
  

  

  

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css" integrity="sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link href="https://zoharrpg.github.io/Junshang-Jia/deep-thought.css" rel="stylesheet" />
  
  

  <title>
    
Junshang Jia | Live Sequence Protocol and Distributed Bitcoin Miner

  </title>

  
  
  

  
</head>

<body class="has-background-white">
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item is-size-5 has-text-weight-bold" href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia">Junshang Jia</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;projects">
            Projects
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;categories">
            Categories
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;document&#x2F;current-resume&#x2F;Junshang_Jia_resume.pdf">
            Resume
          </a>
          
          
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  
  

  
<section class="section">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article class="box">
          <h1 class="title">
            Live Sequence Protocol and Distributed Bitcoin Miner
          </h1>
          <p class="subtitle"></p>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="fas fa-user"></i>
  </span>
  <span>Junshang Jia published on</span>
  <span class="icon">
    <i class="far fa-calendar-alt"></i>
  </span>
  <span><time datetime="2023-12-17">December 17, 2023</time></span>
</span>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="far fa-clock"></i>
  </span>
  <span>16 min,</span>
  <span class="icon">
    <i class="fas fa-pencil-alt"></i>
  </span>
  <span>3032 words</span>
</span>

            </div>
            <div class="column">
              
              
<p>
  Categories:
  
  <a class="has-text-info-dark has-text-weight-semibold" href="https://zoharrpg.github.io/Junshang-Jia/categories/cmu-15640/">
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-cube"></i>
      </span>
      <span>CMU-15640</span>
    </span>
  </a>
  
  <a class="has-text-info-dark has-text-weight-semibold" href="https://zoharrpg.github.io/Junshang-Jia/categories/distributed-system/">
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-cube"></i>
      </span>
      <span>Distributed System</span>
    </span>
  </a>
  
</p>

              
            </div>
            <div class="column has-text-right-desktop">
              
            </div>
          </div>
          <div class="content mt-2">
            <h1 id="overview">Overview</h1>
<p>CMU-15640 Distributed Systems Project 1<br>
This project will consist of the following two parts:
• Part 1: Implement the Live Sequence Protocol, a homegrown protocol for providing reliable communication with simple client and server APIs on top of the Internet UDP protocol.
• Part 2: Implement a Distributed Bitcoin Miner.<br>
<a href="https://github.com/zoharrpg/Distributed-Bitcoin-Miner">Source Code Link</a><br>

<a href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;15640-doc&#x2F;p1_23.pdf">Write-Up</a></p>
<h1 id="part-1-live-sequence-protocol">Part 1 - Live Sequence Protocol</h1>
<h2 id="lsp-overview">LSP Overview</h2>
<ul>
<li>Unlike UDP or TCP, it supports a client-server communication model.</li>
<li>The server maintains connections between a number of clients, each of which is identified by a numeric connection identifier.</li>
<li>Communication between the server and a client consists of a sequence of discrete messages in each direction.</li>
<li>Message sizes are limited to fit within single UDP packets (around 1,000 bytes).</li>
<li>Messages are sent reliably: a message sent over the network must be received exactly once, and messages must be received in the same order they were sent.</li>
<li>Message integrity is ensured: a message sent over the network will be rejected if modified in transit.</li>
<li>The server and clients monitor the status of their connections and detect when the other side has become disconnected.</li>
</ul>
<h2 id="message-type-and-acknowledge">Message type and Acknowledge</h2>
<p>In this project, there are common message and acknledge message type, and the implementation is following:<br></p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#b48ead;">type </span><span>Message </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">Type     </span><span style="color:#b48ead;">MsgType </span><span style="color:#65737e;">// One of the message types listed above.
</span><span>	</span><span style="color:#bf616a;">ConnID   </span><span style="color:#b48ead;">int     </span><span style="color:#65737e;">// Unique client-server connection ID.
</span><span>	</span><span style="color:#bf616a;">SeqNum   </span><span style="color:#b48ead;">int     </span><span style="color:#65737e;">// Message sequence number.
</span><span>	</span><span style="color:#bf616a;">Size     </span><span style="color:#b48ead;">int     </span><span style="color:#65737e;">// Size of the payload.
</span><span>	</span><span style="color:#bf616a;">Checksum </span><span style="color:#b48ead;">uint16  </span><span style="color:#65737e;">// Message checksum.
</span><span>	</span><span style="color:#bf616a;">Payload  </span><span>[]</span><span style="color:#b48ead;">byte  </span><span style="color:#65737e;">// Data message payload.
</span><span>}
</span></code></pre>
<p>The Communication is following:<br>

<img src="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;processed_images&#x2F;p1-pic1.b4561764dffb7ce9.png" />

<img src="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;processed_images&#x2F;p1-pic2.1f4950449c3914ab.png" />

<img src="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;processed_images&#x2F;p1-pic3.43ed9c29c0c39ac7.png" /></p>
<p>This protocol also supports the  Epoch events to make server robust.</p>
<p>Three Epoch events concepts define here:</p>
<p><strong>EpochLimit</strong> - the maximum amount of epochs that can elapse without a response before we declare the connection dead. We need an epoch limit in order to ensure that we eventually drop dead connections.</p>
<p><strong>CurrentBackoff</strong> - the amount of epochs we wait before re-transmitting data that did not receive an ACK. For instance, if CurrentBackoff is 8, and we just tried to send some data but did not receive an ACK, then we will only attempt to resend the data again after waiting 8 epochs. We provide some more examples below.</p>
<p><strong>MaxBackOffInterval</strong> - the maximum amount of epochs we wait without retrying to transmit data. As in the name, CurrentBackoff is always less than or equal to MaxBackOffInterval</p>
<h2 id="server-api-implementation">Server API Implementation</h2>
<p>In this project, I mainly focus on using Go channel to handel threads and manage the requests coming from client.</p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#b48ead;">type </span><span>server </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">listener         </span><span>*</span><span style="color:#bf616a;">lspnet</span><span>.</span><span style="color:#b48ead;">UDPConn            </span><span style="color:#65737e;">// server listener
</span><span>	</span><span style="color:#bf616a;">rawMessages      </span><span style="color:#b48ead;">chan MessagePacket         </span><span style="color:#65737e;">// receive message from client channel
</span><span>	</span><span style="color:#bf616a;">closeMain        </span><span style="color:#b48ead;">chan int                   </span><span style="color:#65737e;">// close server signal
</span><span>	</span><span style="color:#bf616a;">closeClient      </span><span style="color:#b48ead;">chan int                   </span><span style="color:#65737e;">// close client signal
</span><span>	</span><span style="color:#bf616a;">readMessages     </span><span style="color:#b48ead;">chan Message               </span><span style="color:#65737e;">// Read channel
</span><span>	</span><span style="color:#bf616a;">addrAndSeqNum    </span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">int</span><span>]*</span><span style="color:#b48ead;">Client_seq        </span><span style="color:#65737e;">// ID to client seq map, to get client seq by connId
</span><span>	</span><span style="color:#bf616a;">readCounters     </span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">int</span><span>]</span><span style="color:#b48ead;">int                </span><span style="color:#65737e;">// read counter for each connId
</span><span>	</span><span style="color:#bf616a;">outOfOrderList   </span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">int</span><span>]*</span><span style="color:#bf616a;">list</span><span>.</span><span style="color:#b48ead;">List         </span><span style="color:#65737e;">// outorder list for each connId
</span><span>	</span><span style="color:#bf616a;">windows          </span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">int</span><span>][]</span><span style="color:#b48ead;">Message          </span><span style="color:#65737e;">// slide window for each client
</span><span>	</span><span style="color:#bf616a;">windowOutOfOrder </span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">int</span><span>][]</span><span style="color:#b48ead;">Message          </span><span style="color:#65737e;">// slide window outorder list
</span><span>	</span><span style="color:#bf616a;">isMessageSent    </span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">int</span><span>]</span><span style="color:#b48ead;">bool               </span><span style="color:#65737e;">// in each epoch, True if there is message sent
</span><span>	</span><span style="color:#bf616a;">sendMessages     </span><span style="color:#b48ead;">chan SendPackage           </span><span style="color:#65737e;">// send message from server queue channel for send message from server
</span><span>	</span><span style="color:#bf616a;">readList         </span><span>*</span><span style="color:#bf616a;">list</span><span>.</span><span style="color:#b48ead;">List                 </span><span style="color:#65737e;">// store ordered message
</span><span>	</span><span style="color:#bf616a;">readRequest      </span><span style="color:#b48ead;">chan int                   </span><span style="color:#65737e;">// send read signal
</span><span>	</span><span style="color:#bf616a;">messageDupMap    </span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">int</span><span>]</span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">int</span><span>]</span><span style="color:#b48ead;">bool       </span><span style="color:#65737e;">// id to receive request seq
</span><span>	</span><span style="color:#bf616a;">connectionDupMap </span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">string</span><span>]</span><span style="color:#b48ead;">bool            </span><span style="color:#65737e;">// // The above code is declaring a variable called `connectionDupMap` which is a map with string keys and boolean values.
</span><span>	</span><span style="color:#bf616a;">idleEpochElapsed </span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">int</span><span>]</span><span style="color:#b48ead;">int                </span><span style="color:#65737e;">//connid to epoch
</span><span>	</span><span style="color:#bf616a;">messageBackoff   </span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">MessageId</span><span>]*</span><span style="color:#b48ead;">BackOffInfo </span><span style="color:#65737e;">// The above code is declaring a variable named &quot;messageBackoff&quot; which is a map with keys of type &quot;MessageId&quot; and values of type &quot;*BackOffInfo&quot;.
</span><span>	</span><span style="color:#bf616a;">closePending     </span><span style="color:#b48ead;">chan int                   </span><span style="color:#65737e;">// wait for message sent and acknowledgement.
</span><span>	</span><span style="color:#bf616a;">closeId          </span><span style="color:#b48ead;">int                        </span><span style="color:#65737e;">// a variable called &quot;closeId&quot; of type int.
</span><span>	</span><span style="color:#bf616a;">isClosed         </span><span style="color:#b48ead;">bool                       </span><span style="color:#65737e;">// a boolean variable named &quot;isClosed&quot; and initializing it to false.
</span><span>	</span><span style="color:#bf616a;">droppedId        </span><span style="color:#b48ead;">chan int                   </span><span style="color:#65737e;">// drop connection id channel
</span><span>	</span><span style="color:#bf616a;">params           </span><span>*</span><span style="color:#b48ead;">Params                    </span><span style="color:#65737e;">// params for server
</span><span>}
</span></code></pre>
<p>Go channel and select statement is a powerful tool to handel threads by using message passing, which make it very easy to write the server code. I also use the ticker library to send signal to channel to allow the server to support Epoch events.</p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#b48ead;">func </span><span>(</span><span style="color:#bf616a;">s </span><span>*</span><span style="color:#b48ead;">server</span><span>) </span><span style="color:#8fa1b3;">mainRoutine</span><span>() {
</span><span>	</span><span style="color:#65737e;">// The above code is creating a new ticker in Go. A ticker is a channel-based timer that will send a
</span><span>	</span><span style="color:#65737e;">// value periodically based on the specified duration. In this case, the ticker will send a value
</span><span>	</span><span style="color:#65737e;">// every `s.params.EpochMillis` milliseconds.
</span><span>	</span><span style="color:#bf616a;">ticker </span><span>:= </span><span style="color:#bf616a;">time</span><span>.</span><span style="color:#bf616a;">NewTicker</span><span>(</span><span style="color:#bf616a;">time</span><span>.</span><span style="color:#bf616a;">Duration</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">EpochMillis</span><span>) * </span><span style="color:#bf616a;">time</span><span>.</span><span style="color:#bf616a;">Millisecond</span><span>)
</span><span>	</span><span style="color:#65737e;">// The above code is declaring a variable called `clientIdCounter` and initializing it with a value of 1
</span><span>	</span><span style="color:#bf616a;">clientIdCounter </span><span>:= </span><span style="color:#d08770;">1
</span><span>	</span><span style="color:#65737e;">// The above code is using the `defer` keyword to schedule the `Stop()` method of the `ticker` object
</span><span>	</span><span style="color:#65737e;">// to be called when the surrounding function returns. This is typically used to ensure that resources
</span><span>	</span><span style="color:#65737e;">// are properly cleaned up or released at the end of a function, regardless of how the function exits
</span><span>	</span><span style="color:#65737e;">// (e.g. through a return statement or an error).
</span><span>	</span><span style="color:#b48ead;">defer </span><span style="color:#bf616a;">ticker</span><span>.</span><span style="color:#bf616a;">Stop</span><span>()
</span><span>	</span><span style="color:#b48ead;">for </span><span>{
</span><span>		</span><span style="color:#b48ead;">select </span><span>{
</span><span>		</span><span style="color:#65737e;">// The above code is handling different types of messages received by a server in a Go program.
</span><span>		</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">packet </span><span>:= &lt;-</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">rawMessages</span><span>:
</span><span>			</span><span style="color:#bf616a;">message </span><span>:= </span><span style="color:#bf616a;">packet</span><span>.</span><span style="color:#bf616a;">message
</span><span>			</span><span style="color:#bf616a;">sn </span><span>:= </span><span style="color:#bf616a;">message</span><span>.</span><span style="color:#bf616a;">SeqNum
</span><span>			</span><span style="color:#bf616a;">messageAddr </span><span>:= </span><span style="color:#bf616a;">packet</span><span>.</span><span style="color:#bf616a;">packetAddr
</span><span>			</span><span style="color:#bf616a;">connId </span><span>:= </span><span style="color:#bf616a;">message</span><span>.</span><span style="color:#bf616a;">ConnID
</span><span>			</span><span style="color:#b48ead;">switch </span><span style="color:#bf616a;">packet</span><span>.</span><span style="color:#bf616a;">message</span><span>.</span><span style="color:#bf616a;">Type </span><span>{
</span><span>			</span><span style="color:#65737e;">// The above code is handling the MsgAck case in a switch statement. It performs the following
</span><span>			</span><span style="color:#65737e;">// actions:
</span><span>			</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">MsgAck</span><span>:
</span><span>				</span><span style="color:#65737e;">// The above code is checking if a key `connId` exists in the `idleEpochElapsed` map. If the key
</span><span>				</span><span style="color:#65737e;">// exists, it sets the value associated with that key to 0. If the key does not exist, it continues
</span><span>				</span><span style="color:#65737e;">// to the next iteration of the loop.
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">exist </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">idleEpochElapsed</span><span>[</span><span style="color:#bf616a;">connId</span><span>]; </span><span style="color:#bf616a;">exist </span><span>{
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">idleEpochElapsed</span><span>[</span><span style="color:#bf616a;">connId</span><span>] = </span><span style="color:#d08770;">0
</span><span>				} </span><span style="color:#b48ead;">else </span><span>{
</span><span>					</span><span style="color:#b48ead;">continue
</span><span>				}
</span><span>
</span><span>				</span><span style="color:#65737e;">// The above code is removing an element from a slice and deleting a key-value pair from a map.
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>] = </span><span style="color:#bf616a;">removeFromSlice</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>], </span><span style="color:#bf616a;">sn</span><span>)
</span><span>				</span><span style="color:#bf616a;">messageId </span><span>:= </span><span style="color:#bf616a;">MessageId</span><span>{</span><span style="color:#bf616a;">connId</span><span>: </span><span style="color:#bf616a;">connId</span><span>, </span><span style="color:#bf616a;">seqNum</span><span>: </span><span style="color:#bf616a;">sn</span><span>}
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">exist </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageBackoff</span><span>[</span><span style="color:#bf616a;">messageId</span><span>]; </span><span style="color:#bf616a;">exist </span><span>{
</span><span>					</span><span style="color:#96b5b4;">delete</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageBackoff</span><span>, </span><span style="color:#bf616a;">messageId</span><span>)
</span><span>				} </span><span style="color:#b48ead;">else </span><span>{
</span><span>					</span><span style="color:#b48ead;">continue
</span><span>				}
</span><span>
</span><span>				</span><span style="color:#65737e;">// The above code is part of a function in the Go programming language. It is iterating over a
</span><span>				</span><span style="color:#65737e;">// slice of messages in `s.windowOutOfOrder[connId]`. For each message, it checks if the
</span><span>				</span><span style="color:#65737e;">// `s.windows[connId]` slice is empty or if the message&#39;s sequence number is within the window size
</span><span>				</span><span style="color:#65737e;">// and the number of unacknowledged messages is less than the maximum allowed. If the conditions
</span><span>				</span><span style="color:#65737e;">// are met, it marshals the message into JSON, writes it to a UDP connection, and updates various
</span><span>				</span><span style="color:#65737e;">// data structures and variables.
</span><span>				</span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">tmp </span><span>[]</span><span style="color:#b48ead;">int
</span><span>				</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">m </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windowOutOfOrder</span><span>[</span><span style="color:#bf616a;">connId</span><span>] {
</span><span>					</span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>]) == </span><span style="color:#d08770;">0 </span><span>|| (</span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">SeqNum </span><span>&lt; </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>][</span><span style="color:#d08770;">0</span><span>].</span><span style="color:#bf616a;">SeqNum</span><span>+</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">WindowSize </span><span>&amp;&amp; </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>]) &lt; </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">MaxUnackedMessages</span><span>) {
</span><span>						</span><span style="color:#bf616a;">marMessage</span><span>, </span><span style="color:#bf616a;">_ </span><span>:= </span><span style="color:#bf616a;">json</span><span>.</span><span style="color:#bf616a;">Marshal</span><span>(</span><span style="color:#bf616a;">m</span><span>)
</span><span>						</span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">err </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">listener</span><span>.</span><span style="color:#bf616a;">WriteToUDP</span><span>(</span><span style="color:#bf616a;">marMessage</span><span>, </span><span style="color:#bf616a;">messageAddr</span><span>)
</span><span>						</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">err </span><span>!= </span><span style="color:#d08770;">nil </span><span>{
</span><span>						}
</span><span>
</span><span>						</span><span style="color:#bf616a;">tmp </span><span>= </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">tmp</span><span>, </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">SeqNum</span><span>)
</span><span>						</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageBackoff</span><span>[</span><span style="color:#bf616a;">MessageId</span><span>{</span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">ConnID</span><span>, </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">SeqNum</span><span>}] = &amp;</span><span style="color:#bf616a;">BackOffInfo</span><span>{</span><span style="color:#d08770;">0</span><span>, </span><span style="color:#d08770;">0</span><span>, </span><span style="color:#d08770;">0</span><span>, </span><span style="color:#bf616a;">m</span><span>}
</span><span>						</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>] = </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>], </span><span style="color:#bf616a;">m</span><span>)
</span><span>						</span><span style="color:#bf616a;">sort</span><span>.</span><span style="color:#bf616a;">Slice</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>], </span><span style="color:#b48ead;">func</span><span>(</span><span style="color:#bf616a;">i</span><span>, </span><span style="color:#bf616a;">j </span><span style="color:#b48ead;">int</span><span>) </span><span style="color:#b48ead;">bool </span><span>{
</span><span>							</span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>][</span><span style="color:#bf616a;">i</span><span>].</span><span style="color:#bf616a;">SeqNum </span><span>&lt; </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>][</span><span style="color:#bf616a;">j</span><span>].</span><span style="color:#bf616a;">SeqNum
</span><span>						})
</span><span>					}
</span><span>				}
</span><span>				</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">seqNum </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">tmp </span><span>{
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windowOutOfOrder</span><span>[</span><span style="color:#bf616a;">connId</span><span>] = </span><span style="color:#bf616a;">removeFromSlice</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windowOutOfOrder</span><span>[</span><span style="color:#bf616a;">connId</span><span>], </span><span style="color:#bf616a;">seqNum</span><span>)
</span><span>				}
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">connId </span><span>== </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">closeId </span><span>&amp;&amp; </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>])+</span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windowOutOfOrder</span><span>[</span><span style="color:#bf616a;">connId</span><span>]) == </span><span style="color:#d08770;">0 </span><span>{
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">endConnection</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">closeId</span><span>)
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">closeId </span><span>= -</span><span style="color:#d08770;">1
</span><span>
</span><span>				}
</span><span>
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">isClosed </span><span>&amp;&amp; </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">checkClosed</span><span>() {
</span><span>					</span><span style="color:#b48ead;">return
</span><span>				}
</span><span>
</span><span>			</span><span style="color:#65737e;">// The above code is handling the MsgCAck case in a switch statement. It performs the following
</span><span>			</span><span style="color:#65737e;">// actions:
</span><span>			</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">MsgCAck</span><span>:
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">exist </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">idleEpochElapsed</span><span>[</span><span style="color:#bf616a;">connId</span><span>]; </span><span style="color:#bf616a;">exist </span><span>{
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">idleEpochElapsed</span><span>[</span><span style="color:#bf616a;">connId</span><span>] = </span><span style="color:#d08770;">0
</span><span>
</span><span>				}
</span><span>
</span><span>				</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">m </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>] {
</span><span>					</span><span style="color:#bf616a;">m_id </span><span>:= </span><span style="color:#bf616a;">MessageId</span><span>{</span><span style="color:#bf616a;">connId</span><span>: </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">ConnID</span><span>, </span><span style="color:#bf616a;">seqNum</span><span>: </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">SeqNum</span><span>}
</span><span>					</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">exist </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageBackoff</span><span>[</span><span style="color:#bf616a;">m_id</span><span>]; </span><span style="color:#bf616a;">exist </span><span>{
</span><span>						</span><span style="color:#96b5b4;">delete</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageBackoff</span><span>, </span><span style="color:#bf616a;">m_id</span><span>)
</span><span>					} </span><span style="color:#b48ead;">else </span><span>{
</span><span>						</span><span style="color:#b48ead;">continue
</span><span>					}
</span><span>				}
</span><span>
</span><span>				</span><span style="color:#65737e;">// The above code is removing an element from a slice called `s.windows[connId]`. The element being
</span><span>				</span><span style="color:#65737e;">// removed is determined by the value of `sn`.
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>] = </span><span style="color:#bf616a;">removeFromSliceCAck</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>], </span><span style="color:#bf616a;">sn</span><span>)
</span><span>
</span><span>				</span><span style="color:#65737e;">// The above code is iterating over messages in the `windowOutOfOrder` slice for a specific
</span><span>				</span><span style="color:#65737e;">// `connId`. It checks if the `windows` slice for that `connId` is empty or if the current
</span><span>				</span><span style="color:#65737e;">// message&#39;s sequence number is within the window range and the number of unacknowledged messages
</span><span>				</span><span style="color:#65737e;">// is less than the maximum allowed. If the conditions are met, it marshals the message into JSON,
</span><span>				</span><span style="color:#65737e;">// writes it to the UDP listener, updates the `windows` slice and `messageBackoff` map, and sorts
</span><span>				</span><span style="color:#65737e;">// the `windows` slice based on sequence number.
</span><span>				</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">m </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windowOutOfOrder</span><span>[</span><span style="color:#bf616a;">connId</span><span>] {
</span><span>					</span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>]) == </span><span style="color:#d08770;">0 </span><span>|| (</span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">SeqNum </span><span>&lt; </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>][</span><span style="color:#d08770;">0</span><span>].</span><span style="color:#bf616a;">SeqNum</span><span>+</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">WindowSize </span><span>&amp;&amp; </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>]) &lt; </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">MaxUnackedMessages</span><span>) {
</span><span>						</span><span style="color:#bf616a;">marMessage</span><span>, </span><span style="color:#bf616a;">_ </span><span>:= </span><span style="color:#bf616a;">json</span><span>.</span><span style="color:#bf616a;">Marshal</span><span>(</span><span style="color:#bf616a;">m</span><span>)
</span><span>						</span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">err </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">listener</span><span>.</span><span style="color:#bf616a;">WriteToUDP</span><span>(</span><span style="color:#bf616a;">marMessage</span><span>, </span><span style="color:#bf616a;">messageAddr</span><span>)
</span><span>						</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">err </span><span>!= </span><span style="color:#d08770;">nil </span><span>{
</span><span>						}
</span><span>						</span><span style="color:#65737e;">// update unack count
</span><span>						</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>] = </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>], </span><span style="color:#bf616a;">m</span><span>)
</span><span>						</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageBackoff</span><span>[</span><span style="color:#bf616a;">MessageId</span><span>{</span><span style="color:#bf616a;">connId</span><span>: </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">ConnID</span><span>, </span><span style="color:#bf616a;">seqNum</span><span>: </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">SeqNum</span><span>}] = &amp;</span><span style="color:#bf616a;">BackOffInfo</span><span>{</span><span style="color:#d08770;">0</span><span>, </span><span style="color:#d08770;">0</span><span>, </span><span style="color:#d08770;">0</span><span>, </span><span style="color:#bf616a;">m</span><span>}
</span><span>						</span><span style="color:#bf616a;">sort</span><span>.</span><span style="color:#bf616a;">Slice</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>], </span><span style="color:#b48ead;">func</span><span>(</span><span style="color:#bf616a;">i</span><span>, </span><span style="color:#bf616a;">j </span><span style="color:#b48ead;">int</span><span>) </span><span style="color:#b48ead;">bool </span><span>{
</span><span>							</span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>][</span><span style="color:#bf616a;">i</span><span>].</span><span style="color:#bf616a;">SeqNum </span><span>&lt; </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>][</span><span style="color:#bf616a;">j</span><span>].</span><span style="color:#bf616a;">SeqNum
</span><span>						})
</span><span>					}
</span><span>				}
</span><span>
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">closeId </span><span>!= -</span><span style="color:#d08770;">1 </span><span>&amp;&amp; </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">closeId</span><span>])+</span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windowOutOfOrder</span><span>[</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">closeId</span><span>]) == </span><span style="color:#d08770;">0 </span><span>{
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">endConnection</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">closeId</span><span>)
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">closeId </span><span>= -</span><span style="color:#d08770;">1
</span><span>				}
</span><span>
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">isClosed </span><span>&amp;&amp; </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">checkClosed</span><span>() {
</span><span>					</span><span style="color:#b48ead;">return
</span><span>				}
</span><span>
</span><span>			</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">MsgConnect</span><span>:
</span><span>				</span><span style="color:#65737e;">// The above code is sending an acknowledgment message to a client. It first creates an
</span><span>				</span><span style="color:#65737e;">// acknowledgment message using the client ID counter and sequence number. Then, it marshals the
</span><span>				</span><span style="color:#65737e;">// acknowledgment message into JSON format. Next, it writes the marshaled acknowledgment message to
</span><span>				</span><span style="color:#65737e;">// the UDP listener. If the write operation is successful, it initializes various data structures
</span><span>				</span><span style="color:#65737e;">// and maps related to the client&#39;s connection. Finally, it increments the client ID counter.
</span><span>				</span><span style="color:#bf616a;">ackMessage </span><span>:= *</span><span style="color:#bf616a;">NewAck</span><span>(</span><span style="color:#bf616a;">clientIdCounter</span><span>, </span><span style="color:#bf616a;">sn</span><span>)
</span><span>				</span><span style="color:#bf616a;">ackMessageMar</span><span>, </span><span style="color:#bf616a;">err </span><span>:= </span><span style="color:#bf616a;">json</span><span>.</span><span style="color:#bf616a;">Marshal</span><span>(</span><span style="color:#bf616a;">ackMessage</span><span>)
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">err </span><span>!= </span><span style="color:#d08770;">nil </span><span>{
</span><span>				}
</span><span>
</span><span>				</span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">err </span><span>= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">listener</span><span>.</span><span style="color:#bf616a;">WriteToUDP</span><span>(</span><span style="color:#bf616a;">ackMessageMar</span><span>, </span><span style="color:#bf616a;">messageAddr</span><span>)
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">err </span><span>!= </span><span style="color:#d08770;">nil </span><span>{
</span><span>				}
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">exist </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">connectionDupMap</span><span>[</span><span style="color:#bf616a;">packet</span><span>.</span><span style="color:#bf616a;">packetAddr</span><span>.</span><span style="color:#bf616a;">String</span><span>()]; </span><span style="color:#bf616a;">exist </span><span>{
</span><span>					</span><span style="color:#b48ead;">continue
</span><span>				}
</span><span>				</span><span style="color:#65737e;">// initialize map
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">addrAndSeqNum</span><span>[</span><span style="color:#bf616a;">clientIdCounter</span><span>] = &amp;</span><span style="color:#bf616a;">Client_seq</span><span>{</span><span style="color:#bf616a;">packet</span><span>.</span><span style="color:#bf616a;">packetAddr</span><span>, </span><span style="color:#bf616a;">sn </span><span>+ </span><span style="color:#d08770;">1</span><span>}
</span><span>				</span><span style="color:#65737e;">// message start from sn+1
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">readCounters</span><span>[</span><span style="color:#bf616a;">clientIdCounter</span><span>] = </span><span style="color:#bf616a;">sn </span><span>+ </span><span style="color:#d08770;">1
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">outOfOrderList</span><span>[</span><span style="color:#bf616a;">clientIdCounter</span><span>] = </span><span style="color:#bf616a;">list</span><span>.</span><span style="color:#bf616a;">New</span><span>()
</span><span>
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">clientIdCounter</span><span>] = </span><span style="color:#96b5b4;">make</span><span>([]</span><span style="color:#b48ead;">Message</span><span>, </span><span style="color:#d08770;">0</span><span>)
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windowOutOfOrder</span><span>[</span><span style="color:#bf616a;">clientIdCounter</span><span>] = </span><span style="color:#96b5b4;">make</span><span>([]</span><span style="color:#b48ead;">Message</span><span>, </span><span style="color:#d08770;">0</span><span>)
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageDupMap</span><span>[</span><span style="color:#bf616a;">clientIdCounter</span><span>] = </span><span style="color:#96b5b4;">make</span><span>(</span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">int</span><span>]</span><span style="color:#b48ead;">bool</span><span>)
</span><span>				</span><span style="color:#65737e;">// mark connect this
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">connectionDupMap</span><span>[</span><span style="color:#bf616a;">packet</span><span>.</span><span style="color:#bf616a;">packetAddr</span><span>.</span><span style="color:#bf616a;">String</span><span>()] = </span><span style="color:#d08770;">true
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">idleEpochElapsed</span><span>[</span><span style="color:#bf616a;">clientIdCounter</span><span>] = </span><span style="color:#d08770;">0
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">isMessageSent</span><span>[</span><span style="color:#bf616a;">clientIdCounter</span><span>] = </span><span style="color:#d08770;">false
</span><span>
</span><span>				</span><span style="color:#65737e;">// add id counter
</span><span>				</span><span style="color:#bf616a;">clientIdCounter</span><span>++
</span><span>
</span><span>			</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">MsgData</span><span>:
</span><span>				</span><span style="color:#65737e;">// The above code is handling the reception of messages in a network communication system. Here is
</span><span>				</span><span style="color:#65737e;">// a breakdown of what it does:
</span><span>
</span><span>				</span><span style="color:#65737e;">// The above code is checking if a key `connId` exists in the `s.idleEpochElapsed` map. If the key
</span><span>				</span><span style="color:#65737e;">// exists, it sets the value associated with that key to 0.
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">exist </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">idleEpochElapsed</span><span>[</span><span style="color:#bf616a;">connId</span><span>]; </span><span style="color:#bf616a;">exist </span><span>{
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">idleEpochElapsed</span><span>[</span><span style="color:#bf616a;">connId</span><span>] = </span><span style="color:#d08770;">0
</span><span>				}
</span><span>
</span><span>				</span><span style="color:#65737e;">// The above code is sending an acknowledgment message to a specific UDP address.
</span><span>				</span><span style="color:#bf616a;">ackMessage </span><span>:= *</span><span style="color:#bf616a;">NewAck</span><span>(</span><span style="color:#bf616a;">connId</span><span>, </span><span style="color:#bf616a;">sn</span><span>)
</span><span>				</span><span style="color:#bf616a;">ackMessageMar</span><span>, </span><span style="color:#bf616a;">err </span><span>:= </span><span style="color:#bf616a;">json</span><span>.</span><span style="color:#bf616a;">Marshal</span><span>(</span><span style="color:#bf616a;">ackMessage</span><span>)
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">err </span><span>!= </span><span style="color:#d08770;">nil </span><span>{
</span><span>				}
</span><span>				</span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">err </span><span>= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">listener</span><span>.</span><span style="color:#bf616a;">WriteToUDP</span><span>(</span><span style="color:#bf616a;">ackMessageMar</span><span>, </span><span style="color:#bf616a;">messageAddr</span><span>)
</span><span>
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">exist </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageDupMap</span><span>[</span><span style="color:#bf616a;">connId</span><span>][</span><span style="color:#bf616a;">sn</span><span>]; </span><span style="color:#bf616a;">exist </span><span>{
</span><span>					</span><span style="color:#b48ead;">continue
</span><span>				}
</span><span>				</span><span style="color:#65737e;">// mark receive, for dup reason
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageDupMap</span><span>[</span><span style="color:#bf616a;">connId</span><span>][</span><span style="color:#bf616a;">sn</span><span>] = </span><span style="color:#d08770;">true
</span><span>				</span><span style="color:#65737e;">// make active_client become 0
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">idleEpochElapsed</span><span>[</span><span style="color:#bf616a;">connId</span><span>] = </span><span style="color:#d08770;">0
</span><span>
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">err </span><span>!= </span><span style="color:#d08770;">nil </span><span>{
</span><span>				}
</span><span>
</span><span>				</span><span style="color:#65737e;">// if received message match the read counter, just add it to read_list
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">sn </span><span>== </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">readCounters</span><span>[</span><span style="color:#bf616a;">connId</span><span>] {
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">readList</span><span>.</span><span style="color:#bf616a;">PushBack</span><span>(</span><span style="color:#bf616a;">packet</span><span>.</span><span style="color:#bf616a;">message</span><span>)
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">readCounters</span><span>[</span><span style="color:#bf616a;">connId</span><span>]++
</span><span>					</span><span style="color:#65737e;">// check if there is an element in out-of-order list that match the seq number after
</span><span>					</span><span style="color:#bf616a;">element </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">findElement</span><span>(</span><span style="color:#bf616a;">connId</span><span>, </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">readCounters</span><span>[</span><span style="color:#bf616a;">connId</span><span>])
</span><span>					</span><span style="color:#65737e;">// add element until there is no element in out-of-order list that match seq number
</span><span>					</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">element </span><span>!= </span><span style="color:#d08770;">nil </span><span>{
</span><span>						</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">readList</span><span>.</span><span style="color:#bf616a;">PushBack</span><span>(</span><span style="color:#bf616a;">element</span><span>.</span><span style="color:#bf616a;">Value</span><span>.(</span><span style="color:#b48ead;">Message</span><span>))
</span><span>						</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">readCounters</span><span>[</span><span style="color:#bf616a;">connId</span><span>]++
</span><span>						</span><span style="color:#bf616a;">element </span><span>= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">findElement</span><span>(</span><span style="color:#bf616a;">connId</span><span>, </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">readCounters</span><span>[</span><span style="color:#bf616a;">connId</span><span>])
</span><span>					}
</span><span>				} </span><span style="color:#b48ead;">else </span><span>{
</span><span>					</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">outOfOrderList</span><span>[</span><span style="color:#bf616a;">connId</span><span>] == </span><span style="color:#d08770;">nil </span><span>{
</span><span>						</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">outOfOrderList</span><span>[</span><span style="color:#bf616a;">connId</span><span>] = </span><span style="color:#bf616a;">list</span><span>.</span><span style="color:#bf616a;">New</span><span>()
</span><span>					}
</span><span>					</span><span style="color:#65737e;">// out-of-order element
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">outOfOrderList</span><span>[</span><span style="color:#bf616a;">connId</span><span>].</span><span style="color:#bf616a;">PushBack</span><span>(</span><span style="color:#bf616a;">packet</span><span>.</span><span style="color:#bf616a;">message</span><span>)
</span><span>				}
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">manageReadList</span><span>()
</span><span>			}
</span><span>		</span><span style="color:#65737e;">// The above code is using a select statement to wait for a read request on the channel
</span><span>		</span><span style="color:#65737e;">// `s.readRequest`. Once a read request is received, it calls the `manageReadList()` function.
</span><span>		</span><span style="color:#b48ead;">case </span><span>&lt;-</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">readRequest</span><span>:
</span><span>			</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">manageReadList</span><span>()
</span><span>		</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">sendPackage </span><span>:= &lt;-</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">sendMessages</span><span>:
</span><span>			</span><span style="color:#bf616a;">connId </span><span>:= </span><span style="color:#bf616a;">sendPackage</span><span>.</span><span style="color:#bf616a;">connId
</span><span>			</span><span style="color:#bf616a;">serverMessageInfo</span><span>, </span><span style="color:#bf616a;">ok </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">addrAndSeqNum</span><span>[</span><span style="color:#bf616a;">connId</span><span>]
</span><span>
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">ok </span><span>{
</span><span>				</span><span style="color:#bf616a;">seqNum </span><span>:= </span><span style="color:#bf616a;">serverMessageInfo</span><span>.</span><span style="color:#bf616a;">serverSeq
</span><span>				</span><span style="color:#bf616a;">checksum </span><span>:= </span><span style="color:#bf616a;">CalculateChecksum</span><span>(</span><span style="color:#bf616a;">connId</span><span>, </span><span style="color:#bf616a;">seqNum</span><span>, </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">sendPackage</span><span>.</span><span style="color:#bf616a;">payload</span><span>), </span><span style="color:#bf616a;">sendPackage</span><span>.</span><span style="color:#bf616a;">payload</span><span>)
</span><span>				</span><span style="color:#bf616a;">message </span><span>:= *</span><span style="color:#bf616a;">NewData</span><span>(</span><span style="color:#bf616a;">connId</span><span>, </span><span style="color:#bf616a;">seqNum</span><span>, </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">sendPackage</span><span>.</span><span style="color:#bf616a;">payload</span><span>), </span><span style="color:#bf616a;">sendPackage</span><span>.</span><span style="color:#bf616a;">payload</span><span>, </span><span style="color:#bf616a;">checksum</span><span>)
</span><span>
</span><span>				</span><span style="color:#65737e;">// check window
</span><span>
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>]) == </span><span style="color:#d08770;">0 </span><span>|| (</span><span style="color:#bf616a;">seqNum </span><span>&lt; </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>][</span><span style="color:#d08770;">0</span><span>].</span><span style="color:#bf616a;">SeqNum</span><span>+</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">WindowSize </span><span>&amp;&amp; </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>]) &lt; </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">MaxUnackedMessages</span><span>) {
</span><span>					</span><span style="color:#bf616a;">marMessage</span><span>, </span><span style="color:#bf616a;">_ </span><span>:= </span><span style="color:#bf616a;">json</span><span>.</span><span style="color:#bf616a;">Marshal</span><span>(</span><span style="color:#bf616a;">message</span><span>)
</span><span>
</span><span>					</span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">err </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">listener</span><span>.</span><span style="color:#bf616a;">WriteToUDP</span><span>(</span><span style="color:#bf616a;">marMessage</span><span>, </span><span style="color:#bf616a;">serverMessageInfo</span><span>.</span><span style="color:#bf616a;">packetAddr</span><span>)
</span><span>
</span><span>					</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">err </span><span>!= </span><span style="color:#d08770;">nil </span><span>{
</span><span>					}
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">isMessageSent</span><span>[</span><span style="color:#bf616a;">connId</span><span>] = </span><span style="color:#d08770;">true
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageBackoff</span><span>[</span><span style="color:#bf616a;">MessageId</span><span>{</span><span style="color:#bf616a;">connId</span><span>, </span><span style="color:#bf616a;">seqNum</span><span>}] = &amp;</span><span style="color:#bf616a;">BackOffInfo</span><span>{</span><span style="color:#d08770;">0</span><span>, </span><span style="color:#d08770;">0</span><span>, </span><span style="color:#d08770;">0</span><span>, </span><span style="color:#bf616a;">message</span><span>}
</span><span>
</span><span>					</span><span style="color:#65737e;">// update unack count
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>] = </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>], </span><span style="color:#bf616a;">message</span><span>)
</span><span>					</span><span style="color:#bf616a;">sort</span><span>.</span><span style="color:#bf616a;">Slice</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>], </span><span style="color:#b48ead;">func</span><span>(</span><span style="color:#bf616a;">i</span><span>, </span><span style="color:#bf616a;">j </span><span style="color:#b48ead;">int</span><span>) </span><span style="color:#b48ead;">bool </span><span>{
</span><span>						</span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>][</span><span style="color:#bf616a;">i</span><span>].</span><span style="color:#bf616a;">SeqNum </span><span>&lt; </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>][</span><span style="color:#bf616a;">j</span><span>].</span><span style="color:#bf616a;">SeqNum
</span><span>					})
</span><span>				} </span><span style="color:#b48ead;">else </span><span>{
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windowOutOfOrder</span><span>[</span><span style="color:#bf616a;">connId</span><span>] = </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windowOutOfOrder</span><span>[</span><span style="color:#bf616a;">connId</span><span>], </span><span style="color:#bf616a;">message</span><span>)
</span><span>					</span><span style="color:#bf616a;">sort</span><span>.</span><span style="color:#bf616a;">Slice</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windowOutOfOrder</span><span>[</span><span style="color:#bf616a;">connId</span><span>], </span><span style="color:#b48ead;">func</span><span>(</span><span style="color:#bf616a;">i</span><span>, </span><span style="color:#bf616a;">j </span><span style="color:#b48ead;">int</span><span>) </span><span style="color:#b48ead;">bool </span><span>{
</span><span>						</span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windowOutOfOrder</span><span>[</span><span style="color:#bf616a;">connId</span><span>][</span><span style="color:#bf616a;">i</span><span>].</span><span style="color:#bf616a;">SeqNum </span><span>&lt; </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windowOutOfOrder</span><span>[</span><span style="color:#bf616a;">connId</span><span>][</span><span style="color:#bf616a;">j</span><span>].</span><span style="color:#bf616a;">SeqNum
</span><span>					})
</span><span>				}
</span><span>				</span><span style="color:#65737e;">// update seq id
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">addrAndSeqNum</span><span>[</span><span style="color:#bf616a;">connId</span><span>].</span><span style="color:#bf616a;">serverSeq</span><span>++
</span><span>			}
</span><span>
</span><span>		</span><span style="color:#b48ead;">case </span><span>&lt;-</span><span style="color:#bf616a;">ticker</span><span>.</span><span style="color:#bf616a;">C</span><span>:
</span><span>			</span><span style="color:#65737e;">// add epoch to every client state count
</span><span>			</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">k </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">idleEpochElapsed </span><span>{
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">idleEpochElapsed</span><span>[</span><span style="color:#bf616a;">k</span><span>]++
</span><span>				</span><span style="color:#65737e;">// end the connection
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">idleEpochElapsed</span><span>[</span><span style="color:#bf616a;">k</span><span>] &gt;= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">EpochLimit </span><span>{
</span><span>					</span><span style="color:#b48ead;">if </span><span>!</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">containID</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">readList</span><span>, </span><span style="color:#bf616a;">k</span><span>) &amp;&amp; </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">outOfOrderList</span><span>[</span><span style="color:#bf616a;">k</span><span>].</span><span style="color:#bf616a;">Len</span><span>() == </span><span style="color:#d08770;">0 </span><span>{
</span><span>						</span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">droppedId</span><span>) == </span><span style="color:#d08770;">0 </span><span>{
</span><span>							</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">droppedId </span><span>&lt;- </span><span style="color:#bf616a;">k
</span><span>							</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">endConnection</span><span>(</span><span style="color:#bf616a;">k</span><span>)
</span><span>						}
</span><span>					}
</span><span>
</span><span>				}
</span><span>			}
</span><span>
</span><span>			</span><span style="color:#65737e;">// send heartbeat
</span><span>			</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">k</span><span>, </span><span style="color:#bf616a;">v </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">isMessageSent </span><span>{
</span><span>				</span><span style="color:#b48ead;">if </span><span>!</span><span style="color:#bf616a;">v </span><span>{
</span><span>					</span><span style="color:#bf616a;">ackMessage </span><span>:= *</span><span style="color:#bf616a;">NewAck</span><span>(</span><span style="color:#bf616a;">k</span><span>, </span><span style="color:#d08770;">0</span><span>)
</span><span>					</span><span style="color:#bf616a;">ackMessageMar</span><span>, </span><span style="color:#bf616a;">err </span><span>:= </span><span style="color:#bf616a;">json</span><span>.</span><span style="color:#bf616a;">Marshal</span><span>(</span><span style="color:#bf616a;">ackMessage</span><span>)
</span><span>					</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">err </span><span>!= </span><span style="color:#d08770;">nil </span><span>{
</span><span>					}
</span><span>
</span><span>					</span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">err </span><span>= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">listener</span><span>.</span><span style="color:#bf616a;">WriteToUDP</span><span>(</span><span style="color:#bf616a;">ackMessageMar</span><span>, </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">addrAndSeqNum</span><span>[</span><span style="color:#bf616a;">k</span><span>].</span><span style="color:#bf616a;">packetAddr</span><span>)
</span><span>					</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">err </span><span>!= </span><span style="color:#d08770;">nil </span><span>{
</span><span>					}
</span><span>
</span><span>				}
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">isMessageSent</span><span>[</span><span style="color:#bf616a;">k</span><span>] = </span><span style="color:#d08770;">false
</span><span>			}
</span><span>
</span><span>			</span><span style="color:#65737e;">// backoff timer
</span><span>
</span><span>			</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">k</span><span>, </span><span style="color:#bf616a;">v </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageBackoff </span><span>{
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">v</span><span>.</span><span style="color:#bf616a;">totalBackOff </span><span>== </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">EpochLimit </span><span>{
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">endConnection</span><span>(</span><span style="color:#bf616a;">k</span><span>.</span><span style="color:#bf616a;">connId</span><span>)
</span><span>					</span><span style="color:#b48ead;">continue
</span><span>				}
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">v</span><span>.</span><span style="color:#bf616a;">runningBackoff </span><span>&gt;= </span><span style="color:#bf616a;">v</span><span>.</span><span style="color:#bf616a;">currentBackoff </span><span>{
</span><span>					</span><span style="color:#bf616a;">addr </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">addrAndSeqNum</span><span>[</span><span style="color:#bf616a;">k</span><span>.</span><span style="color:#bf616a;">connId</span><span>].</span><span style="color:#bf616a;">packetAddr
</span><span>					</span><span style="color:#bf616a;">marMessage</span><span>, </span><span style="color:#bf616a;">_ </span><span>:= </span><span style="color:#bf616a;">json</span><span>.</span><span style="color:#bf616a;">Marshal</span><span>(</span><span style="color:#bf616a;">v</span><span>.</span><span style="color:#bf616a;">message</span><span>)
</span><span>					</span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">err </span><span>:= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">listener</span><span>.</span><span style="color:#bf616a;">WriteToUDP</span><span>(</span><span style="color:#bf616a;">marMessage</span><span>, </span><span style="color:#bf616a;">addr</span><span>)
</span><span>
</span><span>					</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">err </span><span>!= </span><span style="color:#d08770;">nil </span><span>{
</span><span>					}
</span><span>					</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageBackoff</span><span>[</span><span style="color:#bf616a;">k</span><span>].</span><span style="color:#bf616a;">currentBackoff </span><span>== </span><span style="color:#d08770;">0 </span><span>{
</span><span>						</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageBackoff</span><span>[</span><span style="color:#bf616a;">k</span><span>].</span><span style="color:#bf616a;">currentBackoff</span><span>++
</span><span>					} </span><span style="color:#b48ead;">else </span><span>{
</span><span>						</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageBackoff</span><span>[</span><span style="color:#bf616a;">k</span><span>].</span><span style="color:#bf616a;">currentBackoff </span><span>*= </span><span style="color:#d08770;">2
</span><span>					}
</span><span>					</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageBackoff</span><span>[</span><span style="color:#bf616a;">k</span><span>].</span><span style="color:#bf616a;">currentBackoff </span><span>&gt; </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">MaxBackOffInterval </span><span>{
</span><span>						</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageBackoff</span><span>[</span><span style="color:#bf616a;">k</span><span>].</span><span style="color:#bf616a;">currentBackoff </span><span>= </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">MaxBackOffInterval
</span><span>					}
</span><span>
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageBackoff</span><span>[</span><span style="color:#bf616a;">k</span><span>].</span><span style="color:#bf616a;">runningBackoff </span><span>= </span><span style="color:#d08770;">0
</span><span>					</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageBackoff</span><span>[</span><span style="color:#bf616a;">k</span><span>].</span><span style="color:#bf616a;">totalBackOff</span><span>++
</span><span>					</span><span style="color:#b48ead;">continue
</span><span>				}
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageBackoff</span><span>[</span><span style="color:#bf616a;">k</span><span>].</span><span style="color:#bf616a;">runningBackoff</span><span>++
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">messageBackoff</span><span>[</span><span style="color:#bf616a;">k</span><span>].</span><span style="color:#bf616a;">totalBackOff</span><span>++
</span><span>			}
</span><span>
</span><span>		</span><span style="color:#b48ead;">case </span><span>&lt;-</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">closeMain</span><span>:
</span><span>			</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">isClosed </span><span>= </span><span style="color:#d08770;">true
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">checkClosed</span><span>() {
</span><span>				</span><span style="color:#b48ead;">return
</span><span>			}
</span><span>
</span><span>		</span><span style="color:#65737e;">// close connection for the close client
</span><span>		</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">connId </span><span>:= &lt;-</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">closeClient</span><span>:
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windows</span><span>[</span><span style="color:#bf616a;">connId</span><span>])+</span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">windowOutOfOrder</span><span>[</span><span style="color:#bf616a;">connId</span><span>]) == </span><span style="color:#d08770;">0 </span><span>{
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">endConnection</span><span>(</span><span style="color:#bf616a;">connId</span><span>)
</span><span>			} </span><span style="color:#b48ead;">else </span><span>{
</span><span>				</span><span style="color:#bf616a;">s</span><span>.</span><span style="color:#bf616a;">closeId </span><span>= </span><span style="color:#bf616a;">connId
</span><span>			}
</span><span>		}
</span><span>	}
</span><span>}
</span></code></pre>
<h2 id="potential-improvment-for-server-api">Potential Improvment for Server API</h2>
<p>Current Implementation makes the server side only has one thread to control all the incoming requests,which has performance issues. To improve the performance, it is better to make each request has it own thread handeled in server side.</p>
<h2 id="client-api-implementation">Client API Implementation</h2>
<p>Client API is almost like the server API without a hashmap to record the state of threads.</p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#b48ead;">type </span><span>client </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">conn           </span><span>*</span><span style="color:#bf616a;">lspnet</span><span>.</span><span style="color:#b48ead;">UDPConn
</span><span>	</span><span style="color:#bf616a;">connId         </span><span style="color:#b48ead;">int
</span><span>	</span><span style="color:#bf616a;">connected      </span><span style="color:#b48ead;">chan struct</span><span>{}
</span><span>	</span><span style="color:#bf616a;">rawMessages    </span><span style="color:#b48ead;">chan Message </span><span style="color:#65737e;">// raw message from server
</span><span>	</span><span style="color:#bf616a;">readPayloads   </span><span style="color:#b48ead;">chan </span><span>[]</span><span style="color:#b48ead;">byte  </span><span style="color:#65737e;">// payload from server
</span><span>	</span><span style="color:#bf616a;">readRequest    </span><span style="color:#b48ead;">chan struct</span><span>{}
</span><span>	</span><span style="color:#bf616a;">sendPayloads   </span><span style="color:#b48ead;">chan </span><span>[]</span><span style="color:#b48ead;">byte </span><span style="color:#65737e;">// payload to server
</span><span>	</span><span style="color:#bf616a;">receivedRecord </span><span>[]</span><span style="color:#b48ead;">Message
</span><span>	</span><span style="color:#bf616a;">sn             </span><span style="color:#b48ead;">int </span><span style="color:#65737e;">// seqNum
</span><span>	</span><span style="color:#bf616a;">params         </span><span>*</span><span style="color:#b48ead;">Params
</span><span>	</span><span style="color:#bf616a;">sw             </span><span style="color:#b48ead;">SlidingWindow
</span><span>	</span><span style="color:#bf616a;">backOffMap     </span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">int</span><span>]*</span><span style="color:#b48ead;">BackOff
</span><span>	</span><span style="color:#bf616a;">unsentMessages </span><span>[]</span><span style="color:#b48ead;">Message
</span><span>	</span><span style="color:#bf616a;">closeRead      </span><span style="color:#b48ead;">chan struct</span><span>{}
</span><span>	</span><span style="color:#bf616a;">closeMain      </span><span style="color:#b48ead;">chan struct</span><span>{}
</span><span>	</span><span style="color:#bf616a;">closePending   </span><span style="color:#b48ead;">chan struct</span><span>{}
</span><span>	</span><span style="color:#bf616a;">isClosed       </span><span style="color:#b48ead;">bool
</span><span>}
</span></code></pre>
<p>Client Rountine</p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#b48ead;">func </span><span>(</span><span style="color:#bf616a;">c </span><span>*</span><span style="color:#b48ead;">client</span><span>) </span><span style="color:#8fa1b3;">mainRoutine</span><span>() {
</span><span>	</span><span style="color:#bf616a;">sendingSeqNum </span><span>:= </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">sn </span><span>+ </span><span style="color:#d08770;">1
</span><span>	</span><span style="color:#bf616a;">receiveSeqNum </span><span>:= </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">sn </span><span>+ </span><span style="color:#d08770;">1
</span><span>	</span><span style="color:#bf616a;">isMessageSent </span><span>:= </span><span style="color:#d08770;">false
</span><span>	</span><span style="color:#bf616a;">idleEpochTime </span><span>:= </span><span style="color:#d08770;">0
</span><span>
</span><span>	</span><span style="color:#bf616a;">connectRequest </span><span>:= </span><span style="color:#bf616a;">NewConnect</span><span>(</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">sn</span><span>)
</span><span>	</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">writeToServer</span><span>(*</span><span style="color:#bf616a;">connectRequest</span><span>)
</span><span>	</span><span style="color:#bf616a;">isMessageSent </span><span>= </span><span style="color:#d08770;">true
</span><span>	</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">sw</span><span>.</span><span style="color:#bf616a;">AddMessage</span><span>(*</span><span style="color:#bf616a;">connectRequest</span><span>)
</span><span>	</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">backOffMap</span><span>[</span><span style="color:#bf616a;">connectRequest</span><span>.</span><span style="color:#bf616a;">SeqNum</span><span>] = &amp;</span><span style="color:#bf616a;">BackOff</span><span>{</span><span style="color:#d08770;">0</span><span>, </span><span style="color:#d08770;">0</span><span>}
</span><span>
</span><span>	</span><span style="color:#bf616a;">ticker </span><span>:= </span><span style="color:#bf616a;">time</span><span>.</span><span style="color:#bf616a;">NewTicker</span><span>(</span><span style="color:#bf616a;">time</span><span>.</span><span style="color:#bf616a;">Duration</span><span>(</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">EpochMillis</span><span>) * </span><span style="color:#bf616a;">time</span><span>.</span><span style="color:#bf616a;">Millisecond</span><span>)
</span><span>	</span><span style="color:#b48ead;">defer </span><span style="color:#bf616a;">ticker</span><span>.</span><span style="color:#bf616a;">Stop</span><span>()
</span><span>
</span><span>	</span><span style="color:#bf616a;">heartBeat </span><span>:= </span><span style="color:#bf616a;">Message</span><span>{}
</span><span>
</span><span>	</span><span style="color:#b48ead;">for </span><span>{
</span><span>		</span><span style="color:#b48ead;">select </span><span>{
</span><span>		</span><span style="color:#65737e;">// Close Connection
</span><span>		</span><span style="color:#b48ead;">case </span><span>&lt;-</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">closeMain</span><span>:
</span><span>			</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">isClosed </span><span>= </span><span style="color:#d08770;">true
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">clientCloseCheck</span><span>() {
</span><span>				</span><span style="color:#b48ead;">return
</span><span>			}
</span><span>		</span><span style="color:#b48ead;">case </span><span>&lt;-</span><span style="color:#bf616a;">ticker</span><span>.</span><span style="color:#bf616a;">C</span><span>:
</span><span>			</span><span style="color:#b48ead;">if </span><span>!</span><span style="color:#bf616a;">isMessageSent </span><span>{
</span><span>				</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">writeToServer</span><span>(</span><span style="color:#bf616a;">heartBeat</span><span>)
</span><span>			}
</span><span>			</span><span style="color:#bf616a;">isMessageSent </span><span>= </span><span style="color:#d08770;">false
</span><span>			</span><span style="color:#b48ead;">if </span><span>(</span><span style="color:#bf616a;">idleEpochTime </span><span>&gt;= </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">EpochLimit</span><span>) &amp;&amp; (</span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">receivedRecord</span><span>) == </span><span style="color:#d08770;">0</span><span>) &amp;&amp; (</span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">readPayloads</span><span>) == </span><span style="color:#d08770;">0</span><span>) {
</span><span>				</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">conn</span><span>.</span><span style="color:#bf616a;">Close</span><span>()
</span><span>				</span><span style="color:#96b5b4;">close</span><span>(</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">readPayloads</span><span>)
</span><span>				</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">closePending </span><span>&lt;- </span><span style="color:#b48ead;">struct</span><span>{}{}
</span><span>				</span><span style="color:#b48ead;">return
</span><span>			}
</span><span>			</span><span style="color:#bf616a;">idleEpochTime</span><span>++
</span><span>			</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">message </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">sw</span><span>.</span><span style="color:#bf616a;">window </span><span>{
</span><span>				</span><span style="color:#bf616a;">seqNum </span><span>:= </span><span style="color:#bf616a;">message</span><span>.</span><span style="color:#bf616a;">SeqNum
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">backOffMap</span><span>[</span><span style="color:#bf616a;">seqNum</span><span>].</span><span style="color:#bf616a;">epochElapsed </span><span>&gt;= </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">backOffMap</span><span>[</span><span style="color:#bf616a;">seqNum</span><span>].</span><span style="color:#bf616a;">currentBackoff </span><span>{
</span><span>					</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">backOffMap</span><span>[</span><span style="color:#bf616a;">seqNum</span><span>].</span><span style="color:#bf616a;">currentBackoff </span><span>== </span><span style="color:#d08770;">0 </span><span>{
</span><span>						</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">backOffMap</span><span>[</span><span style="color:#bf616a;">seqNum</span><span>].</span><span style="color:#bf616a;">currentBackoff </span><span>= </span><span style="color:#d08770;">1
</span><span>					} </span><span style="color:#b48ead;">else </span><span>{
</span><span>						</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">backOffMap</span><span>[</span><span style="color:#bf616a;">seqNum</span><span>].</span><span style="color:#bf616a;">currentBackoff </span><span>= </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">backOffMap</span><span>[</span><span style="color:#bf616a;">seqNum</span><span>].</span><span style="color:#bf616a;">currentBackoff </span><span>* </span><span style="color:#d08770;">2
</span><span>					}
</span><span>					</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">backOffMap</span><span>[</span><span style="color:#bf616a;">seqNum</span><span>].</span><span style="color:#bf616a;">currentBackoff </span><span>&gt; </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">MaxBackOffInterval </span><span>{
</span><span>						</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">backOffMap</span><span>[</span><span style="color:#bf616a;">seqNum</span><span>].</span><span style="color:#bf616a;">currentBackoff </span><span>= </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">params</span><span>.</span><span style="color:#bf616a;">MaxBackOffInterval
</span><span>					}
</span><span>					</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">message</span><span>.</span><span style="color:#bf616a;">Type </span><span>== </span><span style="color:#bf616a;">MsgConnect </span><span>{
</span><span>						</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">backOffMap</span><span>[</span><span style="color:#bf616a;">seqNum</span><span>].</span><span style="color:#bf616a;">currentBackoff </span><span>= </span><span style="color:#d08770;">0
</span><span>					}
</span><span>					</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">backOffMap</span><span>[</span><span style="color:#bf616a;">seqNum</span><span>].</span><span style="color:#bf616a;">epochElapsed </span><span>= </span><span style="color:#d08770;">0
</span><span>					</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">writeToServer</span><span>(</span><span style="color:#bf616a;">message</span><span>)
</span><span>					</span><span style="color:#bf616a;">isMessageSent </span><span>= </span><span style="color:#d08770;">true
</span><span>				}
</span><span>				</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">backOffMap</span><span>[</span><span style="color:#bf616a;">seqNum</span><span>].</span><span style="color:#bf616a;">epochElapsed</span><span>++
</span><span>			}
</span><span>		</span><span style="color:#b48ead;">case </span><span>&lt;-</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">readRequest</span><span>:
</span><span>			</span><span style="color:#bf616a;">receiveSeqNum </span><span>= </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">manageReceived</span><span>(</span><span style="color:#bf616a;">receiveSeqNum</span><span>)
</span><span>
</span><span>		</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">payload </span><span>:= &lt;-</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">sendPayloads</span><span>:
</span><span>			</span><span style="color:#bf616a;">checksum </span><span>:= </span><span style="color:#bf616a;">CalculateChecksum</span><span>(</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">ConnID</span><span>(), </span><span style="color:#bf616a;">sendingSeqNum</span><span>, </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">payload</span><span>), </span><span style="color:#bf616a;">payload</span><span>)
</span><span>			</span><span style="color:#bf616a;">message </span><span>:= </span><span style="color:#bf616a;">NewData</span><span>(</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">connId</span><span>, </span><span style="color:#bf616a;">sendingSeqNum</span><span>, </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">payload</span><span>), </span><span style="color:#bf616a;">payload</span><span>, </span><span style="color:#bf616a;">checksum</span><span>)
</span><span>			</span><span style="color:#bf616a;">sendingSeqNum</span><span>++
</span><span>			</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">unsentMessages </span><span>= </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">unsentMessages</span><span>, *</span><span style="color:#bf616a;">message</span><span>)
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">manageToSend</span><span>() == </span><span style="color:#d08770;">true </span><span>{
</span><span>				</span><span style="color:#bf616a;">isMessageSent </span><span>= </span><span style="color:#d08770;">true
</span><span>			}
</span><span>
</span><span>		</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">message </span><span>:= &lt;-</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">rawMessages</span><span>:
</span><span>			</span><span style="color:#bf616a;">idleEpochTime </span><span>= </span><span style="color:#d08770;">0
</span><span>			</span><span style="color:#b48ead;">switch </span><span style="color:#bf616a;">message</span><span>.</span><span style="color:#bf616a;">Type </span><span>{
</span><span>			</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">MsgConnect</span><span>:
</span><span>				</span><span style="color:#b48ead;">continue
</span><span>			</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">MsgAck</span><span>:
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">connId </span><span>== -</span><span style="color:#d08770;">1 </span><span>{
</span><span>					</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">connId </span><span>= </span><span style="color:#bf616a;">message</span><span>.</span><span style="color:#bf616a;">ConnID
</span><span>					</span><span style="color:#bf616a;">heartBeat </span><span>= *</span><span style="color:#bf616a;">NewAck</span><span>(</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">connId</span><span>, </span><span style="color:#d08770;">0</span><span>)
</span><span>					</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">connected </span><span>&lt;- </span><span style="color:#b48ead;">struct</span><span>{}{}
</span><span>				}
</span><span>				</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">sw</span><span>.</span><span style="color:#bf616a;">RemoveSeqNum</span><span>(</span><span style="color:#bf616a;">message</span><span>.</span><span style="color:#bf616a;">SeqNum</span><span>)
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">isClosed </span><span>{
</span><span>					</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">clientCloseCheck</span><span>() {
</span><span>						</span><span style="color:#b48ead;">return
</span><span>					}
</span><span>				}
</span><span>				</span><span style="color:#96b5b4;">delete</span><span>(</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">backOffMap</span><span>, </span><span style="color:#bf616a;">message</span><span>.</span><span style="color:#bf616a;">SeqNum</span><span>)
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">manageToSend</span><span>() == </span><span style="color:#d08770;">true </span><span>{
</span><span>					</span><span style="color:#bf616a;">isMessageSent </span><span>= </span><span style="color:#d08770;">true
</span><span>				}
</span><span>			</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">MsgCAck</span><span>:
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">connId </span><span>== -</span><span style="color:#d08770;">1 </span><span>{
</span><span>					</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">connId </span><span>= </span><span style="color:#bf616a;">message</span><span>.</span><span style="color:#bf616a;">ConnID
</span><span>					</span><span style="color:#bf616a;">heartBeat </span><span>= *</span><span style="color:#bf616a;">NewAck</span><span>(</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">connId</span><span>, </span><span style="color:#d08770;">0</span><span>)
</span><span>					</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">connected </span><span>&lt;- </span><span style="color:#b48ead;">struct</span><span>{}{}
</span><span>				}
</span><span>				</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">sw</span><span>.</span><span style="color:#bf616a;">RemoveBeforeSeqNum</span><span>(</span><span style="color:#bf616a;">message</span><span>.</span><span style="color:#bf616a;">SeqNum</span><span>)
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">isClosed </span><span>{
</span><span>					</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">clientCloseCheck</span><span>() {
</span><span>						</span><span style="color:#b48ead;">return
</span><span>					}
</span><span>				}
</span><span>				</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">key </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">backOffMap </span><span>{
</span><span>					</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">key </span><span>&lt;= </span><span style="color:#bf616a;">message</span><span>.</span><span style="color:#bf616a;">SeqNum </span><span>{
</span><span>						</span><span style="color:#96b5b4;">delete</span><span>(</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">backOffMap</span><span>, </span><span style="color:#bf616a;">key</span><span>)
</span><span>					}
</span><span>				}
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">manageToSend</span><span>() == </span><span style="color:#d08770;">true </span><span>{
</span><span>					</span><span style="color:#bf616a;">isMessageSent </span><span>= </span><span style="color:#d08770;">true
</span><span>				}
</span><span>			</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">MsgData</span><span>:
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">message</span><span>.</span><span style="color:#bf616a;">SeqNum </span><span>&gt;= </span><span style="color:#bf616a;">receiveSeqNum </span><span>{
</span><span>					</span><span style="color:#bf616a;">isDuplicate </span><span>:= </span><span style="color:#d08770;">false
</span><span>					</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">m </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">receivedRecord </span><span>{
</span><span>						</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">message</span><span>.</span><span style="color:#bf616a;">SeqNum </span><span>== </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">SeqNum </span><span>{
</span><span>							</span><span style="color:#bf616a;">isDuplicate </span><span>= </span><span style="color:#d08770;">true
</span><span>							</span><span style="color:#b48ead;">break
</span><span>						}
</span><span>					}
</span><span>					</span><span style="color:#b48ead;">if </span><span>!</span><span style="color:#bf616a;">isDuplicate </span><span>{
</span><span>						</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">receivedRecord </span><span>= </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">receivedRecord</span><span>, </span><span style="color:#bf616a;">message</span><span>)
</span><span>					}
</span><span>				}
</span><span>				</span><span style="color:#bf616a;">receiveSeqNum </span><span>= </span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">manageReceived</span><span>(</span><span style="color:#bf616a;">receiveSeqNum</span><span>)
</span><span>				</span><span style="color:#bf616a;">ackMessage </span><span>:= *</span><span style="color:#bf616a;">NewAck</span><span>(</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">connId</span><span>, </span><span style="color:#bf616a;">message</span><span>.</span><span style="color:#bf616a;">SeqNum</span><span>)
</span><span>				</span><span style="color:#bf616a;">c</span><span>.</span><span style="color:#bf616a;">writeToServer</span><span>(</span><span style="color:#bf616a;">ackMessage</span><span>)
</span><span>			}
</span><span>		}
</span><span>	}
</span><span>}
</span></code></pre>
<h1 id="part-2-bitcoin-miner-based-on-the-lsp">Part 2 - Bitcoin Miner based on the LSP</h1>
<h2 id="scheduler-implementation">Scheduler Implementation</h2>
<p>The main focus on this part is to write the a scheduler to assign the work for multiple machines. To minimize mean response time for all client requests, I assigned jobs evenly across the machines.</p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#65737e;">// scheduler
</span><span style="color:#65737e;">// aims to minimize mean response time for all client requests.
</span><span style="color:#65737e;">// requests that arrive earlier have some sort of priority.
</span><span style="color:#b48ead;">func </span><span>(</span><span style="color:#bf616a;">srv </span><span>*</span><span style="color:#b48ead;">server</span><span>) </span><span style="color:#8fa1b3;">scheduler</span><span>() {
</span><span>	</span><span style="color:#b48ead;">for </span><span>{
</span><span>		</span><span style="color:#b48ead;">select </span><span>{
</span><span>		</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">minerId </span><span>:= &lt;-</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">freeMinerChan</span><span>:
</span><span>			</span><span style="color:#65737e;">// A miner joins the server.
</span><span>			</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">freeMiners </span><span>= </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">freeMiners</span><span>, </span><span style="color:#bf616a;">minerId</span><span>)
</span><span>
</span><span>		</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">index </span><span>:= &lt;-</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">closeMinerChan</span><span>:
</span><span>			</span><span style="color:#65737e;">// remove the miner from freeMiners
</span><span>			</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">freeMiners </span><span>= </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">freeMiners</span><span>[:</span><span style="color:#bf616a;">index</span><span>], </span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">freeMiners</span><span>[</span><span style="color:#bf616a;">index</span><span>+</span><span style="color:#d08770;">1</span><span>:]...)
</span><span>
</span><span>		</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">reassignJob </span><span>:= &lt;-</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">reassignJobChan</span><span>:
</span><span>			</span><span style="color:#65737e;">// find the request from requestList
</span><span>			</span><span style="color:#bf616a;">index </span><span>:= </span><span style="color:#bf616a;">ByRemainingJobs</span><span>(</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestList</span><span>).</span><span style="color:#bf616a;">findByRequestId</span><span>(</span><span style="color:#bf616a;">reassignJob</span><span>.</span><span style="color:#bf616a;">requestId</span><span>)
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">index </span><span>== -</span><span style="color:#d08770;">1 </span><span>{
</span><span>				</span><span style="color:#65737e;">// the corresponding client has been disconnected
</span><span>				</span><span style="color:#b48ead;">continue
</span><span>			}
</span><span>
</span><span>			</span><span style="color:#65737e;">// place the job back to list
</span><span>			</span><span style="color:#bf616a;">job </span><span>:= </span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">busyMiners</span><span>[</span><span style="color:#bf616a;">reassignJob</span><span>.</span><span style="color:#bf616a;">minerId</span><span>].</span><span style="color:#bf616a;">job
</span><span>			</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestList</span><span>[</span><span style="color:#bf616a;">index</span><span>].</span><span style="color:#bf616a;">remainingJobs </span><span>= </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestList</span><span>[</span><span style="color:#bf616a;">index</span><span>].</span><span style="color:#bf616a;">remainingJobs</span><span>, </span><span style="color:#bf616a;">job</span><span>)
</span><span>			</span><span style="color:#bf616a;">sort</span><span>.</span><span style="color:#bf616a;">Sort</span><span>(</span><span style="color:#bf616a;">ByRemainingJobs</span><span>(</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestList</span><span>))
</span><span>
</span><span>			</span><span style="color:#65737e;">// remove the job from the previous miner
</span><span>			</span><span style="color:#96b5b4;">delete</span><span>(</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">busyMiners</span><span>, </span><span style="color:#bf616a;">reassignJob</span><span>.</span><span style="color:#bf616a;">minerId</span><span>)
</span><span>
</span><span>		</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">clientId </span><span>:= &lt;-</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">closeClientChan</span><span>:
</span><span>			</span><span style="color:#65737e;">// remove the requests from requestList
</span><span>			</span><span style="color:#65737e;">/*
</span><span style="color:#65737e;">				requestIds := make([]int, initialListLen)
</span><span style="color:#65737e;">				for reqId, reqMap := range srv.requestInfo {
</span><span style="color:#65737e;">					if reqMap.clientId == clientId {
</span><span style="color:#65737e;">						requestIds = append(requestIds, reqId)
</span><span style="color:#65737e;">					}
</span><span style="color:#65737e;">				}
</span><span style="color:#65737e;">				for _, requestId := range requestIds {
</span><span style="color:#65737e;">					index := ByRemainingJobs(srv.requestList).findByRequestId(requestId)
</span><span style="color:#65737e;">					srv.requestList = append(srv.requestList[:index], srv.requestList[index+1:]...)
</span><span style="color:#65737e;">					delete(srv.requestInfo, requestId)
</span><span style="color:#65737e;">				}
</span><span style="color:#65737e;">			*/
</span><span>			</span><span style="color:#bf616a;">requestId </span><span>:= -</span><span style="color:#d08770;">1
</span><span>			</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">reqId</span><span>, </span><span style="color:#bf616a;">reqMap </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestInfo </span><span>{
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">reqMap</span><span>.</span><span style="color:#bf616a;">clientId </span><span>== </span><span style="color:#bf616a;">clientId </span><span>{
</span><span>					</span><span style="color:#bf616a;">requestId </span><span>= </span><span style="color:#bf616a;">reqId
</span><span>					</span><span style="color:#b48ead;">break
</span><span>				}
</span><span>			}
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">requestId </span><span>== -</span><span style="color:#d08770;">1 </span><span>{
</span><span>				</span><span style="color:#b48ead;">continue
</span><span>			}
</span><span>			</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">removeRequest</span><span>(</span><span style="color:#bf616a;">requestId</span><span>)
</span><span>
</span><span>		</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">req </span><span>:= &lt;-</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestChan</span><span>:
</span><span>			</span><span style="color:#65737e;">// A client sends a request to the server.
</span><span>			</span><span style="color:#bf616a;">msg </span><span>:= </span><span style="color:#bf616a;">req</span><span>.</span><span style="color:#bf616a;">message
</span><span>			</span><span style="color:#65737e;">// For each client request, it splits the request into more manageable-sized jobs
</span><span>			</span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">jobs </span><span>[]</span><span style="color:#b48ead;">job
</span><span>			</span><span style="color:#bf616a;">current </span><span>:= </span><span style="color:#bf616a;">msg</span><span>.</span><span style="color:#bf616a;">Lower
</span><span>			</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">current</span><span>+</span><span style="color:#bf616a;">chunkSize </span><span>&lt; </span><span style="color:#bf616a;">msg</span><span>.</span><span style="color:#bf616a;">Upper </span><span>{
</span><span>				</span><span style="color:#bf616a;">jobs </span><span>= </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">jobs</span><span>, </span><span style="color:#bf616a;">job</span><span>{</span><span style="color:#bf616a;">current</span><span>, </span><span style="color:#bf616a;">current </span><span>+ </span><span style="color:#bf616a;">chunkSize</span><span>})
</span><span>				</span><span style="color:#bf616a;">current </span><span>+= </span><span style="color:#bf616a;">chunkSize
</span><span>			}
</span><span>			</span><span style="color:#bf616a;">jobs </span><span>= </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">jobs</span><span>, </span><span style="color:#bf616a;">job</span><span>{</span><span style="color:#bf616a;">current</span><span>, </span><span style="color:#bf616a;">msg</span><span>.</span><span style="color:#bf616a;">Upper</span><span>})
</span><span>
</span><span>			</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestList </span><span>= </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestList</span><span>, </span><span style="color:#bf616a;">clientRequest</span><span>{</span><span style="color:#bf616a;">req</span><span>.</span><span style="color:#bf616a;">requestId</span><span>, </span><span style="color:#bf616a;">jobs</span><span>})
</span><span>			</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestInfo</span><span>[</span><span style="color:#bf616a;">req</span><span>.</span><span style="color:#bf616a;">requestId</span><span>] = </span><span style="color:#bf616a;">requestMap</span><span>{</span><span style="color:#bf616a;">req</span><span>.</span><span style="color:#bf616a;">clientId</span><span>, </span><span style="color:#bf616a;">msg</span><span>.</span><span style="color:#bf616a;">Data</span><span>, </span><span style="color:#96b5b4;">make</span><span>([]</span><span style="color:#b48ead;">result</span><span>, </span><span style="color:#bf616a;">initialListLen</span><span>), </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">jobs</span><span>)}
</span><span>
</span><span>		</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">res </span><span>:= &lt;-</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">resultChan</span><span>:
</span><span>			</span><span style="color:#65737e;">// append the res
</span><span>			</span><span style="color:#bf616a;">requestId </span><span>:= </span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">busyMiners</span><span>[</span><span style="color:#bf616a;">res</span><span>.</span><span style="color:#bf616a;">minerId</span><span>].</span><span style="color:#bf616a;">requestId
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">ok </span><span>:= </span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestInfo</span><span>[</span><span style="color:#bf616a;">requestId</span><span>]; !</span><span style="color:#bf616a;">ok </span><span>{
</span><span>				</span><span style="color:#b48ead;">continue
</span><span>			}
</span><span>			</span><span style="color:#65737e;">// Get a copy of the requestMap
</span><span>			</span><span style="color:#bf616a;">reqMap </span><span>:= </span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestInfo</span><span>[</span><span style="color:#bf616a;">requestId</span><span>]
</span><span>			</span><span style="color:#bf616a;">reqMap</span><span>.</span><span style="color:#bf616a;">results </span><span>= </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">reqMap</span><span>.</span><span style="color:#bf616a;">results</span><span>, </span><span style="color:#bf616a;">res</span><span>.</span><span style="color:#bf616a;">result</span><span>)
</span><span>			</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestInfo</span><span>[</span><span style="color:#bf616a;">requestId</span><span>] = </span><span style="color:#bf616a;">reqMap
</span><span>
</span><span>			</span><span style="color:#96b5b4;">delete</span><span>(</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">busyMiners</span><span>, </span><span style="color:#bf616a;">res</span><span>.</span><span style="color:#bf616a;">minerId</span><span>)
</span><span>			</span><span style="color:#65737e;">// Work should be divided roughly evenly across workers. Try to minimize the idle time of each worker.
</span><span>			</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">freeMiners </span><span>= </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">freeMiners</span><span>, </span><span style="color:#bf616a;">res</span><span>.</span><span style="color:#bf616a;">minerId</span><span>)
</span><span>
</span><span>			</span><span style="color:#65737e;">// The server waits for each worker to respond before generating and sending the final result back to the client.
</span><span>			</span><span style="color:#65737e;">// Once the miner exhausts all possible nonces, it determines the least hash value and
</span><span>			</span><span style="color:#65737e;">// its corresponding nonce and sends back the final result: [Result minHash nonce]
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestInfo</span><span>[</span><span style="color:#bf616a;">requestId</span><span>].</span><span style="color:#bf616a;">results</span><span>) == </span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestInfo</span><span>[</span><span style="color:#bf616a;">requestId</span><span>].</span><span style="color:#bf616a;">totalNum </span><span>{
</span><span>				</span><span style="color:#65737e;">// sort the results
</span><span>				</span><span style="color:#bf616a;">requestMap </span><span>:= </span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestInfo</span><span>[</span><span style="color:#bf616a;">requestId</span><span>]
</span><span>				</span><span style="color:#bf616a;">sort</span><span>.</span><span style="color:#bf616a;">Sort</span><span>(</span><span style="color:#bf616a;">ByHash</span><span>(</span><span style="color:#bf616a;">requestMap</span><span>.</span><span style="color:#bf616a;">results</span><span>))
</span><span>
</span><span>				</span><span style="color:#bf616a;">result </span><span>:= </span><span style="color:#bf616a;">requestMap</span><span>.</span><span style="color:#bf616a;">results</span><span>[</span><span style="color:#d08770;">0</span><span>]
</span><span>				</span><span style="color:#65737e;">// send the result back to the client
</span><span>				</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">write2client</span><span>(</span><span style="color:#bf616a;">requestMap</span><span>.</span><span style="color:#bf616a;">clientId</span><span>, </span><span style="color:#bf616a;">bitcoin</span><span>.</span><span style="color:#bf616a;">NewResult</span><span>(</span><span style="color:#bf616a;">result</span><span>.</span><span style="color:#bf616a;">hash</span><span>, </span><span style="color:#bf616a;">result</span><span>.</span><span style="color:#bf616a;">nonce</span><span>))
</span><span>
</span><span>				</span><span style="color:#65737e;">// remove the request from requestList
</span><span>				</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">removeRequest</span><span>(</span><span style="color:#bf616a;">requestId</span><span>)
</span><span>			}
</span><span>		</span><span style="color:#b48ead;">default</span><span>:
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestList</span><span>) == </span><span style="color:#d08770;">0 </span><span>{
</span><span>				</span><span style="color:#b48ead;">continue
</span><span>			}
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestList</span><span>[</span><span style="color:#d08770;">0</span><span>].</span><span style="color:#bf616a;">remainingJobs</span><span>) == </span><span style="color:#d08770;">0 </span><span>{
</span><span>				</span><span style="color:#b48ead;">continue
</span><span>			}
</span><span>			</span><span style="color:#65737e;">// If there are no available miners left, the server should wait for a new miner to join
</span><span>			</span><span style="color:#65737e;">// before reassigning the old miner’s job.
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">freeMiners</span><span>) == </span><span style="color:#d08770;">0 </span><span>{
</span><span>				</span><span style="color:#b48ead;">continue
</span><span>			}
</span><span>			</span><span style="color:#65737e;">// LOAD BALANCING POLICY:
</span><span>			</span><span style="color:#65737e;">// FIFO for miner
</span><span>			</span><span style="color:#bf616a;">miner </span><span>:= </span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">freeMiners</span><span>[</span><span style="color:#d08770;">0</span><span>]
</span><span>			</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">freeMiners </span><span>= </span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">freeMiners</span><span>[</span><span style="color:#d08770;">1</span><span>:]
</span><span>
</span><span>			</span><span style="color:#65737e;">// assign the job to the miner
</span><span>			</span><span style="color:#bf616a;">req </span><span>:= </span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestList</span><span>[</span><span style="color:#d08770;">0</span><span>]
</span><span>			</span><span style="color:#bf616a;">job </span><span>:= </span><span style="color:#bf616a;">req</span><span>.</span><span style="color:#bf616a;">remainingJobs</span><span>[</span><span style="color:#d08770;">0</span><span>]
</span><span>
</span><span>			</span><span style="color:#65737e;">// farms them out to its available miners (it is up to you to choose a suitable maximum job size).
</span><span>			</span><span style="color:#65737e;">// The server should be &quot;fair&quot; in the way it distributes tasks.
</span><span>			</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">busyMiners</span><span>[</span><span style="color:#bf616a;">miner</span><span>] = </span><span style="color:#bf616a;">jobInfo</span><span>{</span><span style="color:#bf616a;">req</span><span>.</span><span style="color:#bf616a;">requestId</span><span>, </span><span style="color:#bf616a;">job</span><span>}
</span><span>
</span><span>			</span><span style="color:#65737e;">// send the job to the miner
</span><span>			</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">write2client</span><span>(</span><span style="color:#bf616a;">miner</span><span>, </span><span style="color:#bf616a;">bitcoin</span><span>.</span><span style="color:#bf616a;">NewRequest</span><span>(</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestInfo</span><span>[</span><span style="color:#bf616a;">req</span><span>.</span><span style="color:#bf616a;">requestId</span><span>].</span><span style="color:#bf616a;">message</span><span>, </span><span style="color:#bf616a;">job</span><span>.</span><span style="color:#bf616a;">lower</span><span>, </span><span style="color:#bf616a;">job</span><span>.</span><span style="color:#bf616a;">upper</span><span>))
</span><span>
</span><span>			</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestList</span><span>[</span><span style="color:#d08770;">0</span><span>].</span><span style="color:#bf616a;">remainingJobs </span><span>= </span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestList</span><span>[</span><span style="color:#d08770;">0</span><span>].</span><span style="color:#bf616a;">remainingJobs</span><span>[</span><span style="color:#d08770;">1</span><span>:]
</span><span>			</span><span style="color:#bf616a;">sort</span><span>.</span><span style="color:#bf616a;">Sort</span><span>(</span><span style="color:#bf616a;">ByRemainingJobs</span><span>(</span><span style="color:#bf616a;">srv</span><span>.</span><span style="color:#bf616a;">requestList</span><span>))
</span><span>		}
</span><span>	}
</span><span>}
</span><span>
</span></code></pre>

          </div>
        </article>
      </div>
      
      <div class="column is-2 is-hidden-mobile">
        <aside class="menu" style="position: sticky; top: 48px">
          <p class="heading has-text-weight-bold">Contents</p>
          <ul class="menu-list">
            
            <li>
              <a id="link-overview" class="toc is-size-7 is-active"
                href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-1/#overview">
                Overview
              </a>
              
            </li>
            
            <li>
              <a id="link-part-1-live-sequence-protocol" class="toc is-size-7 "
                href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-1/#part-1-live-sequence-protocol">
                Part 1 - Live Sequence Protocol
              </a>
              
              <ul>
                
                <li>
                  <a id="link-lsp-overview" class="toc is-size-7" href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-1/#lsp-overview">
                    LSP Overview
                  </a>
                </li>
                
                <li>
                  <a id="link-message-type-and-acknowledge" class="toc is-size-7" href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-1/#message-type-and-acknowledge">
                    Message type and Acknowledge
                  </a>
                </li>
                
                <li>
                  <a id="link-server-api-implementation" class="toc is-size-7" href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-1/#server-api-implementation">
                    Server API Implementation
                  </a>
                </li>
                
                <li>
                  <a id="link-potential-improvment-for-server-api" class="toc is-size-7" href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-1/#potential-improvment-for-server-api">
                    Potential Improvment for Server API
                  </a>
                </li>
                
                <li>
                  <a id="link-client-api-implementation" class="toc is-size-7" href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-1/#client-api-implementation">
                    Client API Implementation
                  </a>
                </li>
                
              </ul>
              
            </li>
            
            <li>
              <a id="link-part-2-bitcoin-miner-based-on-the-lsp" class="toc is-size-7 "
                href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-1/#part-2-bitcoin-miner-based-on-the-lsp">
                Part 2 - Bitcoin Miner based on the LSP
              </a>
              
              <ul>
                
                <li>
                  <a id="link-scheduler-implementation" class="toc is-size-7" href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-1/#scheduler-implementation">
                    Scheduler Implementation
                  </a>
                </li>
                
              </ul>
              
            </li>
            
          </ul>
        </aside>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Search</p>
      </header>
      <section class="modal-card-body">
        <div class="field mb-2">
          <div class="control">
            <input class="input" id="search" placeholder="Search this website." type="search" />
          </div>
        </div>
        <div class="search-results">
          <div class="search-results__items"></div>
        </div>
      </section>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


  

<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <nav class="level">
               
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;projects&#x2F;ds-project-2&#x2F;">
              The Raft Consensus Algorithm<span class="icon ml-2">
                <i class="fas fa-arrow-circle-right"></i>
              </span>
            </a>
          </div>
          
        </nav>
      </div>
    </div>
  </div>
</section>



  



  
  <footer class="footer py-4">
    <div class="content has-text-centered">
      <p>
        Built with
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-code"></i>
          </span>
          <span>code</span>
        </span>
        and
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-heart"></i>
          </span>
          <span>love</span>
        </span>
      </p>
      <p>
        Powered by
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-power-off"></i>
          </span>
          <span>zola</span>
        </span>
      </p>
    </div>
  </footer>
  

  
  
  
  
  <script src="https://zoharrpg.github.io/Junshang-Jia/elasticlunr.min.js"></script>
  <script src="https://zoharrpg.github.io/Junshang-Jia/search_index.en.js"></script><script src="https://zoharrpg.github.io/Junshang-Jia/js/site.js"></script>

  

<script type="text/javascript">
  const menuBarHeight = document.querySelector("nav.navbar").clientHeight;
  const tocItems = document.querySelectorAll(".toc");
  const navSections = new Array(tocItems.length);

  tocItems.forEach((el, i) => {
    let id = el.getAttribute("id").substring(5);
    navSections[i] = document.getElementById(id);
  })

  function isVisible(tocIndex) {
    const current = navSections[tocIndex];
    const next = tocIndex < tocItems.length - 1 ? navSections[tocIndex + 1]
      : document.querySelectorAll("section.section").item(1);

    const c = current.getBoundingClientRect();
    const n = next.getBoundingClientRect();
    const h = (window.innerHeight || document.documentElement.clientHeight);

    return (c.top <= h) && (n.top - menuBarHeight >= 0);
  }

  function activateIfVisible() {
    for (b = true, i = 0; i < tocItems.length; i++) {
      if (b && isVisible(i)) {
        tocItems[i].classList.add('is-active');
        b = false;
      } else
        tocItems[i].classList.remove('is-active');
    }
  }

  var isTicking = null;
  window.addEventListener('scroll', () => {
    if (!isTicking) {
      window.requestAnimationFrame(() => {
        activateIfVisible();
        isTicking = false;
      });
      isTicking = true;
    }
  }, false);
</script>





  
  
</body>

</html>
