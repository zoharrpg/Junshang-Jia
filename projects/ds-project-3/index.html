<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <meta content="#ffffff" name="theme-color" />
  <meta content="#da532c" name="msapplication-TileColor" />

  
  <link href='&#x2F;icons&#x2F;site.webmanifest' rel="manifest" />
  
  
  <link color="#5bbad5" href='&#x2F;icons&#x2F;safari-pinned-tab.svg' rel="mask-icon" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-16x16.png' rel="icon" sizes="16x16" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;favicon-32x32.png' rel="icon" sizes="32x32" type="image/png" />
  
  
  <link href='&#x2F;icons&#x2F;apple-touch-icon.png' rel="apple-touch-icon" sizes="180x180" />
  

  

  

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css" integrity="sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css" integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin="anonymous">
  <link href="https://zoharrpg.github.io/Junshang-Jia/deep-thought.css" rel="stylesheet" />
  
  

  <title>
    
Junshang Jia | Multi-User Dungeon-CMUD

  </title>

  
  
  

  
</head>

<body class="has-background-white">
  <nav aria-label="section navigation" class="navbar is-light" role="navigation">
    <div class="container">
      <div class="navbar-brand">
        <a class="navbar-item is-size-5 has-text-weight-bold" href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia">Junshang Jia</a>
        <a aria-expanded="false" aria-label="menu" class="navbar-burger burger" data-target="navMenu" role="button">
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>
      <div class="navbar-menu" id="navMenu">
        <div class="navbar-end has-text-centered">
          
          
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;projects">
            Projects
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;categories">
            Categories
          </a>
          
          <a class="navbar-item has-text-weight-semibold" href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;document&#x2F;current-resume&#x2F;Junshang_Jia_resume.pdf">
            Resume
          </a>
          
          
          
          <a class="navbar-item" id="nav-search" title="Search" data-target="#search-modal">
            <span class="icon">
              <i class="fas fa-search"></i>
            </span>
          </a>
          <a class="navbar-item" id="dark-mode" title="Switch to dark theme">
            <span class="icon">
              <i class="fas fa-adjust"></i>
            </span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  
  

  
<section class="section">
  <div class="container">
    <div class="columns">
      <div class="column is-8 is-offset-2">
        <article class="box">
          <h1 class="title">
            Multi-User Dungeon-CMUD
          </h1>
          <p class="subtitle"></p>
          <div class="columns is-multiline is-gapless">
            <div class="column is-8">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="fas fa-user"></i>
  </span>
  <span>Junshang Jia published on</span>
  <span class="icon">
    <i class="far fa-calendar-alt"></i>
  </span>
  <span><time datetime="2023-12-19">December 19, 2023</time></span>
</span>

            </div>
            <div class="column is-4 has-text-right-desktop">
              
<span class="icon-text has-text-grey">
  <span class="icon">
    <i class="far fa-clock"></i>
  </span>
  <span>8 min,</span>
  <span class="icon">
    <i class="fas fa-pencil-alt"></i>
  </span>
  <span>1508 words</span>
</span>

            </div>
            <div class="column">
              
              
<p>
  Categories:
  
  <a class="has-text-info-dark has-text-weight-semibold" href="https://zoharrpg.github.io/Junshang-Jia/categories/cmu-15640/">
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-cube"></i>
      </span>
      <span>CMU-15640</span>
    </span>
  </a>
  
  <a class="has-text-info-dark has-text-weight-semibold" href="https://zoharrpg.github.io/Junshang-Jia/categories/distributed-system/">
    <span class="icon-text">
      <span class="icon">
        <i class="fas fa-cube"></i>
      </span>
      <span>Distributed System</span>
    </span>
  </a>
  
</p>

              
            </div>
            <div class="column has-text-right-desktop">
              
            </div>
          </div>
          <div class="content mt-2">
            <h1 id="overview">Overview</h1>
<p>CMU-15640 Distributed Systems Project 3<br>
In CMUD, players progress through the ranks of CMU computer science by mining coins,
improving their hardware, and solving hard problems. The game is a Multi-User Dungeon
(MUD), meaning that all players inhabit the same virtual world and interact with it through
a text terminal.</p>
<p>Unlike a traditional MUD with a single application server, CMUD uses the globally dis-
tributed architecture shown in Figure 1. Players run the CMUD client app on their own
machine, which connects to a nearby (low ping) backend storage server. The CMUD client
is stateless, converting the player’s inputs into queries against the backend storage server
and printing out the results. Different backend storage servers “sync” with each other (i.e.,
exchange data in the background) to maintain a single consistent global state, so that all
users see the same virtual world, including each others’ actions.</p>
<p>The backend storage system itself implements a simple key-value store for string keys and
values, similar to Project 0. Specifically, it supports operations to Get and Put key value
pairs, plus an operation to List all key-value pairs starting with a given prefix. Since this
API is very simple, all application logic happens on the client, unlike the classic three-tier
architecture with separate application and backend servers; see Figure 2.
The advantage of this architecture is that it simplifies app development and deployment:
a cloud provider can run the same generic backend storage system for many apps, while
individual app developers only need to code and deploy their app’s client, not their own
servers.</p>
<p><a href="https://github.com/zoharrpg/CMUD">Source Code Link</a><br>

<a href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;15640-doc&#x2F;p3_23.pdf">Write-Up</a></p>
<h1 id="actor-model">Actor Model</h1>
<p>This game will use Actor model to make users connect game simultaneously and share information. The actor model means each user have its own state about itself, and directly send message to other users.

<img src="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;processed_images&#x2F;p3-pic1.59d0291598a58b02.png" /></p>
<h1 id="system-architecture">System Architecture</h1>
<p>
<img src="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;processed_images&#x2F;p3-pic2.e7ba155309e1f956.png" />

<img src="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;processed_images&#x2F;p3-pic3.54dc18e03296d206.png" />

<img src="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;processed_images&#x2F;p3-pic4.a3cfe0ee2da71d2f.png" /></p>
<h1 id="system-implementation">System Implementation</h1>
<h2 id="concurrent-mailbox">Concurrent Mailbox</h2>
<p>Use mutex and conditional veriables to implement unbounded FIFO queue</p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#b48ead;">package </span><span style="color:#bf616a;">actor
</span><span>
</span><span style="color:#b48ead;">import </span><span>(
</span><span>	&quot;</span><span style="color:#a3be8c;">sync</span><span>&quot;
</span><span>)
</span><span>
</span><span style="color:#65737e;">// Mailbox
</span><span style="color:#65737e;">// a thread-safe unbounded FIFO queue.
</span><span style="color:#65737e;">//
</span><span style="color:#65737e;">// You can think of Mailbox like a Go channel with an infinite buffer.
</span><span style="color:#65737e;">//
</span><span style="color:#65737e;">// Mailbox is only exported outside the actor package for use in tests;
</span><span style="color:#65737e;">// we do not expect you to use it, just implement it.
</span><span style="color:#b48ead;">type </span><span>Mailbox </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">mu      sync</span><span>.</span><span style="color:#b48ead;">Mutex
</span><span>	</span><span style="color:#bf616a;">message </span><span>[]</span><span style="color:#b48ead;">any
</span><span>	</span><span style="color:#bf616a;">closed  </span><span style="color:#b48ead;">bool
</span><span>	</span><span style="color:#bf616a;">cond    </span><span>*</span><span style="color:#bf616a;">sync</span><span>.</span><span style="color:#b48ead;">Cond
</span><span>}
</span><span>
</span><span style="color:#65737e;">// NewMailbox Returns a new mailbox that is ready for use.
</span><span style="color:#b48ead;">func </span><span style="color:#8fa1b3;">NewMailbox</span><span>() *</span><span style="color:#b48ead;">Mailbox </span><span>{
</span><span>	</span><span style="color:#bf616a;">mailbox </span><span>:= &amp;</span><span style="color:#bf616a;">Mailbox</span><span>{}
</span><span>	</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">cond </span><span>= </span><span style="color:#bf616a;">sync</span><span>.</span><span style="color:#bf616a;">NewCond</span><span>(&amp;</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">mu</span><span>)
</span><span>	</span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">mailbox
</span><span>}
</span><span>
</span><span style="color:#65737e;">// Push
</span><span style="color:#65737e;">// Pushes message onto the end of the mailbox&#39;s FIFO queue.
</span><span style="color:#65737e;">//
</span><span style="color:#65737e;">// This function should NOT block.
</span><span style="color:#65737e;">//
</span><span style="color:#65737e;">// If mailbox.Close() has already been called, this may ignore the message. It still should NOT block.
</span><span style="color:#65737e;">//
</span><span style="color:#65737e;">// Note: message is not a literal actor message; it is an ActorSystem wrapper around a marshalled actor message.
</span><span style="color:#b48ead;">func </span><span>(</span><span style="color:#bf616a;">mailbox </span><span>*</span><span style="color:#b48ead;">Mailbox</span><span>) </span><span style="color:#8fa1b3;">Push</span><span>(</span><span style="color:#bf616a;">message </span><span style="color:#b48ead;">any</span><span>) {
</span><span>	</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">mu</span><span>.</span><span style="color:#bf616a;">Lock</span><span>()
</span><span>	</span><span style="color:#b48ead;">defer </span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">mu</span><span>.</span><span style="color:#bf616a;">Unlock</span><span>()
</span><span>	</span><span style="color:#b48ead;">if </span><span>!</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">closed </span><span>{
</span><span>		</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">message </span><span>= </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">message</span><span>, </span><span style="color:#bf616a;">message</span><span>)
</span><span>		</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">cond</span><span>.</span><span style="color:#bf616a;">Signal</span><span>()
</span><span>	}
</span><span>}
</span><span>
</span><span style="color:#65737e;">// Pop
</span><span style="color:#65737e;">// Pops a message from the front of the mailbox&#39;s FIFO queue,
</span><span style="color:#65737e;">//
</span><span style="color:#65737e;">// blocking until a message is available.
</span><span style="color:#65737e;">//
</span><span style="color:#65737e;">// If mailbox.Close() is called (either before or during a Pop() call), this should unblock and return (nil, false).
</span><span style="color:#65737e;">// Otherwise, it should return (message, true).
</span><span style="color:#b48ead;">func </span><span>(</span><span style="color:#bf616a;">mailbox </span><span>*</span><span style="color:#b48ead;">Mailbox</span><span>) </span><span style="color:#8fa1b3;">Pop</span><span>() (</span><span style="color:#bf616a;">message </span><span style="color:#b48ead;">any</span><span>, </span><span style="color:#bf616a;">ok </span><span style="color:#b48ead;">bool</span><span>) {
</span><span>	</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">mu</span><span>.</span><span style="color:#bf616a;">Lock</span><span>()
</span><span>	</span><span style="color:#b48ead;">defer </span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">mu</span><span>.</span><span style="color:#bf616a;">Unlock</span><span>()
</span><span>
</span><span>	</span><span style="color:#b48ead;">for </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">message</span><span>) == </span><span style="color:#d08770;">0 </span><span>&amp;&amp; !</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">closed </span><span>{
</span><span>		</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">cond</span><span>.</span><span style="color:#bf616a;">Wait</span><span>()
</span><span>	}
</span><span>	</span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">len</span><span>(</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">message</span><span>) &gt; </span><span style="color:#d08770;">0 </span><span>&amp;&amp; !</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">closed </span><span>{
</span><span>		</span><span style="color:#bf616a;">message </span><span>= </span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">message</span><span>[</span><span style="color:#d08770;">0</span><span>]
</span><span>		</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">message </span><span>= </span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">message</span><span>[</span><span style="color:#d08770;">1</span><span>:]
</span><span>		</span><span style="color:#bf616a;">ok </span><span>= </span><span style="color:#d08770;">true
</span><span>		</span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">message</span><span>, </span><span style="color:#bf616a;">ok
</span><span>	}
</span><span>
</span><span>	</span><span style="color:#b48ead;">return </span><span style="color:#d08770;">nil</span><span>, </span><span style="color:#d08770;">false
</span><span>}
</span><span>
</span><span style="color:#65737e;">// Close
</span><span style="color:#65737e;">// Closes the mailbox, causing future Pop() calls to return (nil, false)
</span><span style="color:#65737e;">// and terminating any goroutines running in the background.
</span><span style="color:#65737e;">//
</span><span style="color:#65737e;">// If Close() has already been called, this may exhibit undefined behavior, including blocking indefinitely.
</span><span style="color:#b48ead;">func </span><span>(</span><span style="color:#bf616a;">mailbox </span><span>*</span><span style="color:#b48ead;">Mailbox</span><span>) </span><span style="color:#8fa1b3;">Close</span><span>() {
</span><span>	</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">mu</span><span>.</span><span style="color:#bf616a;">Lock</span><span>()
</span><span>	</span><span style="color:#b48ead;">defer </span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">mu</span><span>.</span><span style="color:#bf616a;">Unlock</span><span>()
</span><span>
</span><span>	</span><span style="color:#b48ead;">if </span><span>!</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">closed </span><span>{
</span><span>		</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">closed </span><span>= </span><span style="color:#d08770;">true
</span><span>		</span><span style="color:#bf616a;">mailbox</span><span>.</span><span style="color:#bf616a;">cond</span><span>.</span><span style="color:#bf616a;">Broadcast</span><span>()
</span><span>	}
</span><span>}
</span><span>
</span></code></pre>
<h2 id="actor-model-define-type">Actor Model Define Type</h2>
<p>Define Actor Message type and server side implementation</p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#b48ead;">package </span><span style="color:#bf616a;">kvserver
</span><span>
</span><span style="color:#b48ead;">import </span><span>(
</span><span>	&quot;</span><span style="color:#a3be8c;">encoding/gob</span><span>&quot;
</span><span>	&quot;</span><span style="color:#a3be8c;">fmt</span><span>&quot;
</span><span>	&quot;</span><span style="color:#a3be8c;">github.com/cmu440/actor</span><span>&quot;
</span><span>	&quot;</span><span style="color:#a3be8c;">strings</span><span>&quot;
</span><span>	&quot;</span><span style="color:#a3be8c;">time</span><span>&quot;
</span><span>)
</span><span>
</span><span style="color:#65737e;">// Implement your queryActor in this file.
</span><span style="color:#b48ead;">func </span><span style="color:#8fa1b3;">init</span><span>() {
</span><span>	</span><span style="color:#bf616a;">gob</span><span>.</span><span style="color:#bf616a;">Register</span><span>(</span><span style="color:#bf616a;">GetResult</span><span>{})
</span><span>	</span><span style="color:#bf616a;">gob</span><span>.</span><span style="color:#bf616a;">Register</span><span>(</span><span style="color:#bf616a;">Init</span><span>{})
</span><span>	</span><span style="color:#bf616a;">gob</span><span>.</span><span style="color:#bf616a;">Register</span><span>(</span><span style="color:#bf616a;">ListResult</span><span>{})
</span><span>	</span><span style="color:#bf616a;">gob</span><span>.</span><span style="color:#bf616a;">Register</span><span>(</span><span style="color:#bf616a;">SynMsg</span><span>{})
</span><span>	</span><span style="color:#bf616a;">gob</span><span>.</span><span style="color:#bf616a;">Register</span><span>(</span><span style="color:#bf616a;">SynSignal</span><span>{})
</span><span>	</span><span style="color:#bf616a;">gob</span><span>.</span><span style="color:#bf616a;">Register</span><span>(</span><span style="color:#bf616a;">MGet</span><span>{})
</span><span>	</span><span style="color:#bf616a;">gob</span><span>.</span><span style="color:#bf616a;">Register</span><span>(</span><span style="color:#bf616a;">MPut</span><span>{})
</span><span>	</span><span style="color:#bf616a;">gob</span><span>.</span><span style="color:#bf616a;">Register</span><span>(</span><span style="color:#bf616a;">MList</span><span>{})
</span><span>	</span><span style="color:#bf616a;">gob</span><span>.</span><span style="color:#bf616a;">Register</span><span>(</span><span style="color:#bf616a;">PutResult</span><span>{})
</span><span>	</span><span style="color:#bf616a;">gob</span><span>.</span><span style="color:#bf616a;">Register</span><span>(</span><span style="color:#bf616a;">NotifyNewServer</span><span>{})
</span><span>}
</span><span>
</span><span style="color:#65737e;">// queryActor represents an actor that handles GET, PUT, and LIST requests.
</span><span style="color:#b48ead;">type </span><span>queryActor </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">ActorsInfo  </span><span>[]*</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#b48ead;">ActorRef
</span><span>	</span><span style="color:#bf616a;">ActorSystem </span><span>*</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#b48ead;">ActorSystem
</span><span>	</span><span style="color:#bf616a;">Context     </span><span>*</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#b48ead;">ActorContext
</span><span>	</span><span style="color:#bf616a;">Logs        </span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">string</span><span>]</span><span style="color:#b48ead;">MPut
</span><span>	</span><span style="color:#bf616a;">Me          </span><span style="color:#b48ead;">int
</span><span>	</span><span style="color:#bf616a;">RemoteInfo  </span><span>[][]*</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#b48ead;">ActorRef
</span><span>	</span><span style="color:#bf616a;">Store       </span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">string</span><span>]</span><span style="color:#b48ead;">StoreValue
</span><span>}
</span><span>
</span><span style="color:#65737e;">// StoreValue is the value stored in the store
</span><span style="color:#b48ead;">type </span><span>StoreValue </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">Sender    </span><span>*</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#b48ead;">ActorRef
</span><span>	</span><span style="color:#bf616a;">Timestamp </span><span style="color:#b48ead;">int64 </span><span style="color:#65737e;">//millisecond resolution
</span><span>	</span><span style="color:#bf616a;">Value     </span><span style="color:#b48ead;">string
</span><span>}
</span><span>
</span><span style="color:#65737e;">// MGet is the message type for GET requests.
</span><span style="color:#b48ead;">type </span><span>MGet </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">Key    </span><span style="color:#b48ead;">string
</span><span>	</span><span style="color:#bf616a;">Sender </span><span>*</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#b48ead;">ActorRef
</span><span>}
</span><span>
</span><span style="color:#65737e;">// MPut is the message type for PUT requests.
</span><span style="color:#b48ead;">type </span><span>MPut </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">Key       </span><span style="color:#b48ead;">string
</span><span>	</span><span style="color:#bf616a;">Sender    </span><span>*</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#b48ead;">ActorRef
</span><span>	</span><span style="color:#bf616a;">Timestamp </span><span style="color:#b48ead;">int64
</span><span>	</span><span style="color:#bf616a;">Value     </span><span style="color:#b48ead;">string
</span><span>}
</span><span>
</span><span style="color:#65737e;">// MList is the message type for LIST requests.
</span><span style="color:#b48ead;">type </span><span>MList </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">Prefix </span><span style="color:#b48ead;">string
</span><span>	</span><span style="color:#bf616a;">Sender </span><span>*</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#b48ead;">ActorRef
</span><span>}
</span><span>
</span><span style="color:#65737e;">// ListResult is the message type for LIST responses.
</span><span style="color:#b48ead;">type </span><span>ListResult </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">Pair </span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">string</span><span>]</span><span style="color:#b48ead;">string
</span><span>}
</span><span>
</span><span style="color:#65737e;">// GetResult is the message type for GET responses.
</span><span style="color:#b48ead;">type </span><span>GetResult </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">Ok    </span><span style="color:#b48ead;">bool
</span><span>	</span><span style="color:#bf616a;">Value </span><span style="color:#b48ead;">string
</span><span>}
</span><span>
</span><span style="color:#65737e;">// PutResult is the message type for PUT responses.
</span><span style="color:#b48ead;">type </span><span>PutResult </span><span style="color:#b48ead;">struct </span><span>{
</span><span>}
</span><span>
</span><span style="color:#65737e;">// Init is the message type for initializing the queryActor
</span><span style="color:#b48ead;">type </span><span>Init </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">ActorsInfo </span><span>[]*</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#b48ead;">ActorRef
</span><span>	</span><span style="color:#bf616a;">RemoteInfo </span><span>[][]*</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#b48ead;">ActorRef
</span><span>	</span><span style="color:#bf616a;">Me         </span><span style="color:#b48ead;">int
</span><span>}
</span><span>
</span><span style="color:#65737e;">// SynSignal is the message type for triggering synchronization
</span><span style="color:#b48ead;">type </span><span>SynSignal </span><span style="color:#b48ead;">struct </span><span>{
</span><span>}
</span><span>
</span><span style="color:#65737e;">// SynMsg is the message type for synchronization
</span><span style="color:#b48ead;">type </span><span>SynMsg </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">Data </span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">string</span><span>]</span><span style="color:#b48ead;">MPut
</span><span>}
</span><span>
</span><span style="color:#65737e;">// NotifyNewServer is the message type for notifying that a new server came online
</span><span style="color:#b48ead;">type </span><span>NotifyNewServer </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">Refs </span><span>[]*</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#b48ead;">ActorRef
</span><span>}
</span><span>
</span><span style="color:#65737e;">// &quot;Constructor&quot; for queryActors, used in ActorSystem.StartActor.
</span><span style="color:#b48ead;">func </span><span style="color:#8fa1b3;">newQueryActor</span><span>(</span><span style="color:#bf616a;">context </span><span>*</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#b48ead;">ActorContext</span><span>) </span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#b48ead;">Actor </span><span>{
</span><span>	</span><span style="color:#b48ead;">return </span><span>&amp;</span><span style="color:#bf616a;">queryActor</span><span>{
</span><span>		</span><span style="color:#bf616a;">ActorsInfo</span><span>: </span><span style="color:#96b5b4;">make</span><span>([]*</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#b48ead;">ActorRef</span><span>, </span><span style="color:#d08770;">0</span><span>),
</span><span>		</span><span style="color:#bf616a;">Context</span><span>:    </span><span style="color:#bf616a;">context</span><span>,
</span><span>		</span><span style="color:#bf616a;">Logs</span><span>:       </span><span style="color:#96b5b4;">make</span><span>(</span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">string</span><span>]</span><span style="color:#b48ead;">MPut</span><span>),
</span><span>		</span><span style="color:#bf616a;">Me</span><span>:         -</span><span style="color:#d08770;">1</span><span>,
</span><span>		</span><span style="color:#bf616a;">RemoteInfo</span><span>: </span><span style="color:#96b5b4;">make</span><span>([][]*</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#b48ead;">ActorRef</span><span>, </span><span style="color:#d08770;">0</span><span>),
</span><span>		</span><span style="color:#bf616a;">Store</span><span>:      </span><span style="color:#96b5b4;">make</span><span>(</span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">string</span><span>]</span><span style="color:#b48ead;">StoreValue</span><span>),
</span><span>	}
</span><span>}
</span><span>
</span><span style="color:#65737e;">// OnMessage implements actor.Actor.OnMessage.
</span><span style="color:#65737e;">// Sync Strategy:
</span><span style="color:#65737e;">//  1. When a new server joins, it will send a NotifyNewServer message to all servers.
</span><span style="color:#65737e;">//  2. When a server receives a NotifyNewServer message, it will send a SynMsg message to the new server.
</span><span style="color:#65737e;">//  3. When a server receives a SynMsg message, it will update its own store and logs.
</span><span style="color:#65737e;">//  4. Every 100ms, a server will send a SynSignal message to itself
</span><span style="color:#65737e;">//  5. When a server receives a SynSignal message, it will send a SynMsg message to all servers.
</span><span style="color:#b48ead;">func </span><span>(</span><span style="color:#bf616a;">actor </span><span>*</span><span style="color:#b48ead;">queryActor</span><span>) </span><span style="color:#8fa1b3;">OnMessage</span><span>(</span><span style="color:#bf616a;">message </span><span style="color:#b48ead;">any</span><span>) </span><span style="color:#b48ead;">error </span><span>{
</span><span>	</span><span style="color:#b48ead;">switch </span><span style="color:#bf616a;">m </span><span>:= </span><span style="color:#bf616a;">message</span><span>.(</span><span style="color:#b48ead;">type</span><span>) {
</span><span>	</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">NotifyNewServer</span><span>:
</span><span>		</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">RemoteInfo </span><span>= </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">RemoteInfo</span><span>, </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Refs</span><span>)
</span><span>		</span><span style="color:#bf616a;">logs </span><span>:= </span><span style="color:#96b5b4;">make</span><span>(</span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">string</span><span>]</span><span style="color:#b48ead;">MPut</span><span>)
</span><span>
</span><span>		</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">k</span><span>, </span><span style="color:#bf616a;">v </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Store </span><span>{
</span><span>			</span><span style="color:#bf616a;">logs</span><span>[</span><span style="color:#bf616a;">k</span><span>] = </span><span style="color:#bf616a;">MPut</span><span>{</span><span style="color:#bf616a;">Key</span><span>: </span><span style="color:#bf616a;">k</span><span>, </span><span style="color:#bf616a;">Value</span><span>: </span><span style="color:#bf616a;">v</span><span>.</span><span style="color:#bf616a;">Value</span><span>, </span><span style="color:#bf616a;">Sender</span><span>: </span><span style="color:#bf616a;">v</span><span>.</span><span style="color:#bf616a;">Sender</span><span>, </span><span style="color:#bf616a;">Timestamp</span><span>: </span><span style="color:#bf616a;">v</span><span>.</span><span style="color:#bf616a;">Timestamp</span><span>}
</span><span>		}
</span><span>
</span><span>		</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">ref </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Refs </span><span>{
</span><span>			</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Context</span><span>.</span><span style="color:#bf616a;">Tell</span><span>(</span><span style="color:#bf616a;">ref</span><span>, </span><span style="color:#bf616a;">SynMsg</span><span>{</span><span style="color:#bf616a;">Data</span><span>: </span><span style="color:#bf616a;">logs</span><span>})
</span><span>		}
</span><span>
</span><span>	</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">SynSignal</span><span>:
</span><span>		</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">index</span><span>, </span><span style="color:#bf616a;">a </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">ActorsInfo </span><span>{
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">index </span><span>!= </span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Me </span><span>{
</span><span>				</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Context</span><span>.</span><span style="color:#bf616a;">Tell</span><span>(</span><span style="color:#bf616a;">a</span><span>, </span><span style="color:#bf616a;">SynMsg</span><span>{</span><span style="color:#bf616a;">Data</span><span>: </span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Logs</span><span>})
</span><span>			}
</span><span>		}
</span><span>		</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">remote </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">RemoteInfo </span><span>{
</span><span>			</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Context</span><span>.</span><span style="color:#bf616a;">Tell</span><span>(</span><span style="color:#bf616a;">remote</span><span>[</span><span style="color:#d08770;">0</span><span>], </span><span style="color:#bf616a;">SynMsg</span><span>{</span><span style="color:#bf616a;">Data</span><span>: </span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Logs</span><span>})
</span><span>		}
</span><span>		</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Logs </span><span>= </span><span style="color:#96b5b4;">make</span><span>(</span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">string</span><span>]</span><span style="color:#b48ead;">MPut</span><span>)
</span><span>		</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Context</span><span>.</span><span style="color:#bf616a;">TellAfter</span><span>(</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">ActorsInfo</span><span>[</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Me</span><span>], </span><span style="color:#bf616a;">SynSignal</span><span>{}, </span><span style="color:#d08770;">100</span><span>*</span><span style="color:#bf616a;">time</span><span>.</span><span style="color:#bf616a;">Millisecond</span><span>)
</span><span>
</span><span>	</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">SynMsg</span><span>:
</span><span>		</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">_</span><span>, </span><span style="color:#bf616a;">data </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Data </span><span>{
</span><span>			</span><span style="color:#bf616a;">doPut </span><span>:= </span><span style="color:#d08770;">false
</span><span>
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">v</span><span>, </span><span style="color:#bf616a;">ok </span><span>:= </span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Store</span><span>[</span><span style="color:#bf616a;">data</span><span>.</span><span style="color:#bf616a;">Key</span><span>]; </span><span style="color:#bf616a;">ok </span><span>{
</span><span>				</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">data</span><span>.</span><span style="color:#bf616a;">Timestamp </span><span>&gt; </span><span style="color:#bf616a;">v</span><span>.</span><span style="color:#bf616a;">Timestamp </span><span>{
</span><span>					</span><span style="color:#bf616a;">doPut </span><span>= </span><span style="color:#d08770;">true
</span><span>				} </span><span style="color:#b48ead;">else if </span><span style="color:#bf616a;">data</span><span>.</span><span style="color:#bf616a;">Timestamp </span><span>== </span><span style="color:#bf616a;">v</span><span>.</span><span style="color:#bf616a;">Timestamp </span><span>&amp;&amp; </span><span style="color:#bf616a;">data</span><span>.</span><span style="color:#bf616a;">Sender</span><span>.</span><span style="color:#bf616a;">Uid</span><span>() &lt; </span><span style="color:#bf616a;">v</span><span>.</span><span style="color:#bf616a;">Sender</span><span>.</span><span style="color:#bf616a;">Uid</span><span>() {
</span><span>					</span><span style="color:#bf616a;">doPut </span><span>= </span><span style="color:#d08770;">true
</span><span>				}
</span><span>			} </span><span style="color:#b48ead;">else </span><span>{
</span><span>				</span><span style="color:#bf616a;">doPut </span><span>= </span><span style="color:#d08770;">true
</span><span>			}
</span><span>
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">doPut </span><span>{
</span><span>				</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Store</span><span>[</span><span style="color:#bf616a;">data</span><span>.</span><span style="color:#bf616a;">Key</span><span>] = </span><span style="color:#bf616a;">StoreValue</span><span>{</span><span style="color:#bf616a;">data</span><span>.</span><span style="color:#bf616a;">Sender</span><span>, </span><span style="color:#bf616a;">data</span><span>.</span><span style="color:#bf616a;">Timestamp</span><span>, </span><span style="color:#bf616a;">data</span><span>.</span><span style="color:#bf616a;">Value</span><span>}
</span><span>				</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Logs</span><span>[</span><span style="color:#bf616a;">data</span><span>.</span><span style="color:#bf616a;">Key</span><span>] = </span><span style="color:#bf616a;">data
</span><span>			}
</span><span>		}
</span><span>
</span><span>	</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">Init</span><span>:
</span><span>		</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">ActorsInfo </span><span>= </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">ActorsInfo</span><span>, </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">ActorsInfo</span><span>...)
</span><span>		</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">RemoteInfo </span><span>= </span><span style="color:#96b5b4;">append</span><span>(</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">RemoteInfo</span><span>, </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">RemoteInfo</span><span>...)
</span><span>		</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Me </span><span>= </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Me
</span><span>		</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Context</span><span>.</span><span style="color:#bf616a;">Tell</span><span>(</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">ActorsInfo</span><span>[</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Me</span><span>], </span><span style="color:#bf616a;">SynSignal</span><span>{})
</span><span>
</span><span>	</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">MGet</span><span>:
</span><span>		</span><span style="color:#bf616a;">v</span><span>, </span><span style="color:#bf616a;">exist </span><span>:= </span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Store</span><span>[</span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Key</span><span>]
</span><span>		</span><span style="color:#bf616a;">result </span><span>:= </span><span style="color:#bf616a;">GetResult</span><span>{</span><span style="color:#bf616a;">Value</span><span>: </span><span style="color:#bf616a;">v</span><span>.</span><span style="color:#bf616a;">Value</span><span>, </span><span style="color:#bf616a;">Ok</span><span>: </span><span style="color:#bf616a;">exist</span><span>}
</span><span>		</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Context</span><span>.</span><span style="color:#bf616a;">Tell</span><span>(</span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Sender</span><span>, </span><span style="color:#bf616a;">result</span><span>)
</span><span>
</span><span>	</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">MPut</span><span>:
</span><span>		</span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Timestamp </span><span>= </span><span style="color:#bf616a;">time</span><span>.</span><span style="color:#bf616a;">Now</span><span>().</span><span style="color:#bf616a;">UnixMilli</span><span>()
</span><span>		</span><span style="color:#bf616a;">doPut </span><span>:= </span><span style="color:#d08770;">false
</span><span>		</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">v</span><span>, </span><span style="color:#bf616a;">ok </span><span>:= </span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Store</span><span>[</span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Key</span><span>]; </span><span style="color:#bf616a;">ok </span><span>{
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Timestamp </span><span>&gt; </span><span style="color:#bf616a;">v</span><span>.</span><span style="color:#bf616a;">Timestamp </span><span>{
</span><span>				</span><span style="color:#bf616a;">doPut </span><span>= </span><span style="color:#d08770;">true
</span><span>			} </span><span style="color:#b48ead;">else if </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Timestamp </span><span>== </span><span style="color:#bf616a;">v</span><span>.</span><span style="color:#bf616a;">Timestamp </span><span>&amp;&amp; </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Sender</span><span>.</span><span style="color:#bf616a;">Uid</span><span>() &lt; </span><span style="color:#bf616a;">v</span><span>.</span><span style="color:#bf616a;">Sender</span><span>.</span><span style="color:#bf616a;">Uid</span><span>() {
</span><span>				</span><span style="color:#bf616a;">doPut </span><span>= </span><span style="color:#d08770;">true
</span><span>			}
</span><span>		} </span><span style="color:#b48ead;">else </span><span>{
</span><span>			</span><span style="color:#bf616a;">doPut </span><span>= </span><span style="color:#d08770;">true
</span><span>		}
</span><span>		</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">doPut </span><span>{
</span><span>			</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Store</span><span>[</span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Key</span><span>] = </span><span style="color:#bf616a;">StoreValue</span><span>{</span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Sender</span><span>, </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Timestamp</span><span>, </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Value</span><span>}
</span><span>			</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Logs</span><span>[</span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Key</span><span>] = </span><span style="color:#bf616a;">m
</span><span>		}
</span><span>		</span><span style="color:#bf616a;">result </span><span>:= </span><span style="color:#bf616a;">PutResult</span><span>{}
</span><span>		</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Context</span><span>.</span><span style="color:#bf616a;">Tell</span><span>(</span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Sender</span><span>, </span><span style="color:#bf616a;">result</span><span>)
</span><span>
</span><span>	</span><span style="color:#b48ead;">case </span><span style="color:#bf616a;">MList</span><span>:
</span><span>		</span><span style="color:#bf616a;">result </span><span>:= </span><span style="color:#bf616a;">ListResult</span><span>{</span><span style="color:#bf616a;">Pair</span><span>: </span><span style="color:#96b5b4;">make</span><span>(</span><span style="color:#b48ead;">map</span><span>[</span><span style="color:#b48ead;">string</span><span>]</span><span style="color:#b48ead;">string</span><span>)}
</span><span>		</span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">k</span><span>, </span><span style="color:#bf616a;">v </span><span>:= </span><span style="color:#b48ead;">range </span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Store </span><span>{
</span><span>			</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">strings</span><span>.</span><span style="color:#bf616a;">HasPrefix</span><span>(</span><span style="color:#bf616a;">k</span><span>, </span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Prefix</span><span>) {
</span><span>				</span><span style="color:#bf616a;">result</span><span>.</span><span style="color:#bf616a;">Pair</span><span>[</span><span style="color:#bf616a;">k</span><span>] = </span><span style="color:#bf616a;">v</span><span>.</span><span style="color:#bf616a;">Value
</span><span>			}
</span><span>		}
</span><span>		</span><span style="color:#bf616a;">actor</span><span>.</span><span style="color:#bf616a;">Context</span><span>.</span><span style="color:#bf616a;">Tell</span><span>(</span><span style="color:#bf616a;">m</span><span>.</span><span style="color:#bf616a;">Sender</span><span>, </span><span style="color:#bf616a;">result</span><span>)
</span><span>
</span><span>	</span><span style="color:#b48ead;">default</span><span>:
</span><span>		</span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">fmt</span><span>.</span><span style="color:#bf616a;">Errorf</span><span>(&quot;</span><span style="color:#a3be8c;">Unexpected counterActor message type: </span><span style="color:#d08770;">%T</span><span>&quot;, </span><span style="color:#bf616a;">m</span><span>)
</span><span>	}
</span><span>	</span><span style="color:#b48ead;">return </span><span style="color:#d08770;">nil
</span><span>}
</span></code></pre>
<h2 id="rpc-handler">RPC handler</h2>
<p>Used RPC functions for each player</p>
<pre data-lang="go" style="background-color:#2b303b;color:#c0c5ce;" class="language-go "><code class="language-go" data-lang="go"><span style="color:#b48ead;">package </span><span style="color:#bf616a;">actor
</span><span>
</span><span style="color:#b48ead;">import </span><span>(
</span><span>	&quot;</span><span style="color:#a3be8c;">net/rpc</span><span>&quot;
</span><span>)
</span><span>
</span><span style="color:#b48ead;">type </span><span>RemoteTellArgs </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">Ref  </span><span>*</span><span style="color:#b48ead;">ActorRef
</span><span>	</span><span style="color:#bf616a;">Mars </span><span>[]</span><span style="color:#b48ead;">byte
</span><span>}
</span><span>
</span><span style="color:#65737e;">// remoteTellReply represents the reply for the remoteTell RPC.
</span><span style="color:#b48ead;">type </span><span>RemoteTellReply </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#65737e;">// You can define fields here if needed.
</span><span>}
</span><span>
</span><span style="color:#65737e;">//var mailBox *Mailbox
</span><span style="color:#65737e;">//var mux sync.Mutex
</span><span>
</span><span style="color:#65737e;">// Calls system.tellFromRemote(ref, mars) on the remote ActorSystem listening
</span><span style="color:#65737e;">// on ref.Address.
</span><span style="color:#65737e;">//
</span><span style="color:#65737e;">// This function should NOT wait for a reply from the remote system before
</span><span style="color:#65737e;">// returning, to allow sending multiple messages in a row more quickly.
</span><span style="color:#65737e;">// It should ensure that messages are delivered in-order to the remote system.
</span><span style="color:#65737e;">// (You may assume that remoteTell is not called multiple times
</span><span style="color:#65737e;">// concurrently with the same ref.Address).
</span><span style="color:#b48ead;">func </span><span style="color:#8fa1b3;">remoteTell</span><span>(</span><span style="color:#bf616a;">client </span><span>*</span><span style="color:#bf616a;">rpc</span><span>.</span><span style="color:#b48ead;">Client</span><span>, </span><span style="color:#bf616a;">ref </span><span>*</span><span style="color:#b48ead;">ActorRef</span><span>, </span><span style="color:#bf616a;">mars </span><span>[]</span><span style="color:#b48ead;">byte</span><span>) {
</span><span>	</span><span style="color:#65737e;">// TODO (3B): implement this!
</span><span>
</span><span>	</span><span style="color:#bf616a;">args </span><span>:= &amp;</span><span style="color:#bf616a;">RemoteTellArgs</span><span>{</span><span style="color:#bf616a;">Ref</span><span>: </span><span style="color:#bf616a;">ref</span><span>, </span><span style="color:#bf616a;">Mars</span><span>: </span><span style="color:#bf616a;">mars</span><span>}
</span><span>	</span><span style="color:#65737e;">//mailBox.Push(args)
</span><span>
</span><span>	</span><span style="color:#65737e;">//go func() {
</span><span>	</span><span style="color:#65737e;">//	mux.Lock()
</span><span>	</span><span style="color:#65737e;">//	defer mux.Unlock()
</span><span>	</span><span style="color:#65737e;">//	next, ok := mailBox.Pop()
</span><span>	</span><span style="color:#65737e;">//	if !ok {
</span><span>	</span><span style="color:#65737e;">//
</span><span>	</span><span style="color:#65737e;">//		return
</span><span>	</span><span style="color:#65737e;">//	}
</span><span>	</span><span style="color:#bf616a;">client</span><span>.</span><span style="color:#bf616a;">Go</span><span>(&quot;</span><span style="color:#a3be8c;">RemoteTellHandler.RemoteTell</span><span>&quot;, </span><span style="color:#bf616a;">args</span><span>, </span><span style="color:#d08770;">nil</span><span>, </span><span style="color:#d08770;">nil</span><span>)
</span><span>	</span><span style="color:#65737e;">//}()
</span><span>	</span><span style="color:#65737e;">//if err != nil {
</span><span>	</span><span style="color:#65737e;">//	fmt.Printf(&quot;Error calling RemoteTell RPC: %v\n&quot;, err)
</span><span>	</span><span style="color:#65737e;">//	// Handle the error as needed.
</span><span>	</span><span style="color:#65737e;">//}
</span><span>}
</span><span>
</span><span style="color:#65737e;">// Registers an RPC handler on server for remoteTell calls to system.
</span><span style="color:#65737e;">//
</span><span style="color:#65737e;">// You do not need to start the server&#39;s listening on the network;
</span><span style="color:#65737e;">// just register a handler struct that handles remoteTell RPCs by calling
</span><span style="color:#65737e;">// system.tellFromRemote(ref, mars).
</span><span style="color:#b48ead;">func </span><span style="color:#8fa1b3;">registerRemoteTells</span><span>(</span><span style="color:#bf616a;">system </span><span>*</span><span style="color:#b48ead;">ActorSystem</span><span>, </span><span style="color:#bf616a;">server </span><span>*</span><span style="color:#bf616a;">rpc</span><span>.</span><span style="color:#b48ead;">Server</span><span>) </span><span style="color:#b48ead;">error </span><span>{
</span><span>	</span><span style="color:#65737e;">// TODO (3B): implement this!
</span><span>	</span><span style="color:#65737e;">//mailBox = NewMailbox()
</span><span>	</span><span style="color:#bf616a;">handler </span><span>:= &amp;</span><span style="color:#bf616a;">RemoteTellHandler</span><span>{
</span><span>		</span><span style="color:#bf616a;">ActorSys</span><span>: </span><span style="color:#bf616a;">system</span><span>,
</span><span>	}
</span><span>
</span><span>	</span><span style="color:#bf616a;">err </span><span>:= </span><span style="color:#bf616a;">server</span><span>.</span><span style="color:#bf616a;">RegisterName</span><span>(&quot;</span><span style="color:#a3be8c;">RemoteTellHandler</span><span>&quot;, </span><span style="color:#bf616a;">handler</span><span>)
</span><span>	</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">err </span><span>!= </span><span style="color:#d08770;">nil </span><span>{
</span><span>		</span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">err
</span><span>	}
</span><span>
</span><span>	</span><span style="color:#b48ead;">return </span><span style="color:#d08770;">nil
</span><span>}
</span><span>
</span><span style="color:#b48ead;">type </span><span>RemoteTellHandler </span><span style="color:#b48ead;">struct </span><span>{
</span><span>	</span><span style="color:#bf616a;">ActorSys </span><span>*</span><span style="color:#b48ead;">ActorSystem
</span><span>}
</span><span>
</span><span style="color:#65737e;">// TODO (3B): implement your remoteTell RPC handler below!
</span><span>
</span><span style="color:#65737e;">// RemoteTell handles the remoteTell RPC.
</span><span style="color:#b48ead;">func </span><span>(</span><span style="color:#bf616a;">h </span><span>*</span><span style="color:#b48ead;">RemoteTellHandler</span><span>) </span><span style="color:#8fa1b3;">RemoteTell</span><span>(</span><span style="color:#bf616a;">args </span><span>*</span><span style="color:#b48ead;">RemoteTellArgs</span><span>, </span><span style="color:#bf616a;">reply </span><span>*</span><span style="color:#b48ead;">RemoteTellReply</span><span>) </span><span style="color:#b48ead;">error </span><span>{
</span><span>	</span><span style="color:#65737e;">// Call system.tellFromRemote(ref, mars) using the provided arguments.
</span><span>	</span><span style="color:#bf616a;">h</span><span>.</span><span style="color:#bf616a;">ActorSys</span><span>.</span><span style="color:#bf616a;">tellFromRemote</span><span>(</span><span style="color:#bf616a;">args</span><span>.</span><span style="color:#bf616a;">Ref</span><span>, </span><span style="color:#bf616a;">args</span><span>.</span><span style="color:#bf616a;">Mars</span><span>)
</span><span>
</span><span>	</span><span style="color:#b48ead;">return </span><span style="color:#d08770;">nil
</span><span>}
</span></code></pre>

          </div>
        </article>
      </div>
      
      <div class="column is-2 is-hidden-mobile">
        <aside class="menu" style="position: sticky; top: 48px">
          <p class="heading has-text-weight-bold">Contents</p>
          <ul class="menu-list">
            
            <li>
              <a id="link-overview" class="toc is-size-7 is-active"
                href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-3/#overview">
                Overview
              </a>
              
            </li>
            
            <li>
              <a id="link-actor-model" class="toc is-size-7 "
                href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-3/#actor-model">
                Actor Model
              </a>
              
            </li>
            
            <li>
              <a id="link-system-architecture" class="toc is-size-7 "
                href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-3/#system-architecture">
                System Architecture
              </a>
              
            </li>
            
            <li>
              <a id="link-system-implementation" class="toc is-size-7 "
                href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-3/#system-implementation">
                System Implementation
              </a>
              
              <ul>
                
                <li>
                  <a id="link-concurrent-mailbox" class="toc is-size-7" href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-3/#concurrent-mailbox">
                    Concurrent Mailbox
                  </a>
                </li>
                
                <li>
                  <a id="link-actor-model-define-type" class="toc is-size-7" href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-3/#actor-model-define-type">
                    Actor Model Define Type
                  </a>
                </li>
                
                <li>
                  <a id="link-rpc-handler" class="toc is-size-7" href="https://zoharrpg.github.io/Junshang-Jia/projects/ds-project-3/#rpc-handler">
                    RPC handler
                  </a>
                </li>
                
              </ul>
              
            </li>
            
          </ul>
        </aside>
      </div>
      
    </div>
  </div>
</section>


  
  <section class="modal" id="search-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Search</p>
      </header>
      <section class="modal-card-body">
        <div class="field mb-2">
          <div class="control">
            <input class="input" id="search" placeholder="Search this website." type="search" />
          </div>
        </div>
        <div class="search-results">
          <div class="search-results__items"></div>
        </div>
      </section>
    </div>
    <button aria-label="close" class="modal-close is-large"></button>
  </section>
  


  

<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-8">
        <nav class="level">
              
          <div class="level-item has-text-centered">
            <a class="button is-black is-outlined" href="https:&#x2F;&#x2F;zoharrpg.github.io&#x2F;Junshang-Jia&#x2F;projects&#x2F;ds-project-2&#x2F;">
              <span class="icon mr-2">
                <i class="fas fa-arrow-circle-left"></i>
              </span>
              The Raft Consensus Algorithm
            </a>
          </div>
           
        </nav>
      </div>
    </div>
  </div>
</section>



  



  
  <footer class="footer py-4">
    <div class="content has-text-centered">
      <p>
        Built with
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-code"></i>
          </span>
          <span>code</span>
        </span>
        and
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-heart"></i>
          </span>
          <span>love</span>
        </span>
      </p>
      <p>
        Powered by
        <span class="icon-text">
          <span class="icon">
            <i class="fas fa-power-off"></i>
          </span>
          <span>zola</span>
        </span>
      </p>
    </div>
  </footer>
  

  
  
  
  
  <script src="https://zoharrpg.github.io/Junshang-Jia/elasticlunr.min.js"></script>
  <script src="https://zoharrpg.github.io/Junshang-Jia/search_index.en.js"></script><script src="https://zoharrpg.github.io/Junshang-Jia/js/site.js"></script>

  

<script type="text/javascript">
  const menuBarHeight = document.querySelector("nav.navbar").clientHeight;
  const tocItems = document.querySelectorAll(".toc");
  const navSections = new Array(tocItems.length);

  tocItems.forEach((el, i) => {
    let id = el.getAttribute("id").substring(5);
    navSections[i] = document.getElementById(id);
  })

  function isVisible(tocIndex) {
    const current = navSections[tocIndex];
    const next = tocIndex < tocItems.length - 1 ? navSections[tocIndex + 1]
      : document.querySelectorAll("section.section").item(1);

    const c = current.getBoundingClientRect();
    const n = next.getBoundingClientRect();
    const h = (window.innerHeight || document.documentElement.clientHeight);

    return (c.top <= h) && (n.top - menuBarHeight >= 0);
  }

  function activateIfVisible() {
    for (b = true, i = 0; i < tocItems.length; i++) {
      if (b && isVisible(i)) {
        tocItems[i].classList.add('is-active');
        b = false;
      } else
        tocItems[i].classList.remove('is-active');
    }
  }

  var isTicking = null;
  window.addEventListener('scroll', () => {
    if (!isTicking) {
      window.requestAnimationFrame(() => {
        activateIfVisible();
        isTicking = false;
      });
      isTicking = true;
    }
  }, false);
</script>





  
  
</body>

</html>
